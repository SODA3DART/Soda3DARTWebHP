<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kumayu 3Dシューティング - 崇城大学芸術学部美術学科 3Dアートコース</title>
    <!-- Three.js ライブラリ -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <!-- Three.js 拡張ライブラリ -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <!-- GLTFLoader for loading 3D models -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Noto Sans JP', sans-serif;
        }

        /* ゲームUI要素 */
        .game-ui {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            font-size: 24px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            z-index: 100;
            pointer-events: none;
            display: none;
        }

        .game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 48px;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            z-index: 100;
            display: none;
        }

        .restart-button {
            margin-top: 20px;
            background-color: #4285f4;
            color: #fff;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 20px rgba(66, 133, 244, 0.5);
            transition: all 0.3s ease;
            pointer-events: auto;
        }

        .restart-button:hover {
            background-color: #3367d6;
            box-shadow: 0 0 30px rgba(66, 133, 244, 0.8);
            transform: scale(1.05);
        }

        body {
            background-color: #000;
            color: #fff;
            line-height: 1.6;
            overflow: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* ヘッダースタイル */
        header {
            background-color: rgba(0, 0, 0, 0.7);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
        }

        .logo {
            display: flex;
            align-items: center;
        }

        .logo-text {
            font-size: 18px;
            font-weight: 700;
            color: #fff;
        }

        .logo-text span {
            display: block;
            font-size: 14px;
            color: #aaa;
            font-weight: 400;
        }

        nav ul {
            display: flex;
            list-style: none;
        }

        nav ul li {
            margin-left: 30px;
        }

        nav ul li a {
            text-decoration: none;
            color: #fff;
            font-weight: 500;
            transition: color 0.3s;
            position: relative;
            padding-bottom: 5px;
        }

        nav ul li a:after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            background: #4285f4;
            bottom: 0;
            left: 0;
            transition: width 0.3s;
        }

        nav ul li a:hover {
            color: #4285f4;
        }

        nav ul li a:hover:after {
            width: 100%;
        }

        /* ゲームキャンバス */
        #game-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* UI オーバーレイ */
        .ui-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
        }

        .game-title {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #fff;
            font-size: 3rem;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(66, 133, 244, 0.8), 
                         0 0 20px rgba(66, 133, 244, 0.5), 
                         0 0 30px rgba(66, 133, 244, 0.3);
        }

        .game-subtitle {
            margin-top: 20px;
            font-size: 1.5rem;
        }

        .start-button {
            position: absolute;
            bottom: 150px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4285f4;
            color: #fff;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 20px rgba(66, 133, 244, 0.5);
            transition: all 0.3s ease;
            pointer-events: auto;
        }

        .start-button:hover {
            background-color: #3367d6;
            box-shadow: 0 0 30px rgba(66, 133, 244, 0.8);
            transform: translateX(-50%) scale(1.05);
        }

        /* パーティクルエフェクト */
        @keyframes particle-glow {
            0% {
                box-shadow: 0 0 5px 2px rgba(66, 133, 244, 0.3);
            }
            50% {
                box-shadow: 0 0 10px 4px rgba(66, 133, 244, 0.6);
            }
            100% {
                box-shadow: 0 0 5px 2px rgba(66, 133, 244, 0.3);
            }
        }

        .particle {
            position: absolute;
            width: 5px;
            height: 5px;
            background-color: #4285f4;
            border-radius: 50%;
            animation: particle-glow 2s infinite;
            pointer-events: none;
        }

        /* 魔法のエフェクトアニメーション */
        @keyframes magicEffect {
            0% {
                background-position: 0% 50%;
                filter: blur(3px);
                background-image: linear-gradient(90deg,
                #ffb6c1, #ffd700, #98fb98, #add8e6, #d8bfd8);
            }
            50% {
                background-position: 100% 50%;
                filter: blur(2px);
                background-image: linear-gradient(90deg,
                #ffb6c1, #ffd700, #98fb98, #add8e6, #d8bfd8);
            }
            100% {
                background-position: 0% 50%;
                filter: blur(0px);
                background-image: linear-gradient(90deg,
                rgba(255, 255, 255, 0.95) 0%,
                rgba(255, 255, 255, 1) 100%
                );
            }
        }

        .magic-text-effect {
            position: relative;
            display: inline-block;
            background-image: linear-gradient(90deg, 
                #ffb6c1, #ffd700, #98fb98, #add8e6, #d8bfd8);
            background-size: 200% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-fill-color: transparent;
            animation: magicEffect 4s ease-in-out infinite;
        }

        /* パワーアップUI */
        .score-container {
            font-size: 28px;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
        }

        .powerup-container {
            display: flex;
            margin-top: 10px;
            gap: 10px;
        }

        .powerup-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            font-size: 24px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            animation: pulse 1.5s infinite;
        }

        .rapid-fire {
            background-color: rgba(255, 85, 0, 0.3);
            box-shadow: 0 0 10px rgba(255, 85, 0, 0.8);
        }

        .triple-shot {
            background-color: rgba(0, 255, 255, 0.3);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.8);
        }

        .shield {
            background-color: rgba(0, 255, 0, 0.3);
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.8);
        }

        /* パワーアップタイマー */
        .powerup-timers {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            width: 200px;
        }

        .timer-bar-container {
            width: 100%;
            height: 15px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .timer-bar {
            height: 100%;
            border-radius: 10px;
            transition: width 0.1s linear;
        }

        .timer-label {
            position: absolute;
            top: 0;
            left: 5px;
            font-size: 12px;
            line-height: 15px;
            color: white;
            text-shadow: 1px 1px 2px black;
        }

        .timer-rapid-fire .timer-bar {
            background: linear-gradient(to right, #ff5500, #ff8800);
        }

        .timer-triple-shot .timer-bar {
            background: linear-gradient(to right, #00ffff, #00aaff);
        }

        .timer-shield .timer-bar {
            background: linear-gradient(to right, #00ff00, #88ff00);
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <!-- ヘッダー -->
    <header>
        <div class="container header-container">
            <div class="logo">
                <div class="logo-text">崇城大学 芸術学部<span>3Dアートコース</span></div>
            </div>
            <nav>
                <ul>
                    <li><a href="../index.html">ホーム</a></li>
                    <li><a href="../gallery.html">ギャラリー</a></li>
                    <li><a href="../news_event.html">ニュース</a></li>
                    <li><a href="../question.html">よくある質問</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- ゲームキャンバス -->
    <div id="game-container"></div>

    <!-- UI オーバーレイ -->
    <div class="ui-overlay">
        <div class="game-title" id="gameTitle">
            <span class="magic-text-effect">Kumayu 3Dシューティング</span>
            <div class="game-subtitle">崇城大学芸術学部美術学科 3Dアートコース</div>
        </div>
        <button class="start-button" id="startButton">ゲームスタート</button>
        <div id="gameInstructions" style="position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); text-align: center; display: none;">
            <p>WASDキーで移動、スペースキーで射撃</p>
            <p>インベーダーを全て倒そう！</p>
        </div>

        <!-- ゲームUI -->
        <div class="game-ui" id="gameUI">
            <div class="score-container">スコア: <span id="scoreDisplay">0</span></div>
            <div id="powerupUI" class="powerup-container"></div>
            <div class="powerup-timers" id="powerupTimers"></div>
        </div>

        <!-- ゲームオーバー画面 -->
        <div class="game-over" id="gameOver">
            <div>ゲームオーバー</div>
            <div>最終スコア: <span id="finalScore">0</span></div>
            <button class="restart-button" id="restartButton">もう一度プレイ</button>
        </div>
    </div>

    <script>
        // Three.js 変数宣言
        let scene, camera, renderer, controls;
        let player, playerModel;
        let enemies = [], bullets = [], particles = [];
        let explosions = []; // 爆発エフェクト用配列
        let scorePopups = []; // スコアポップアップ用配列
        let powerUps = []; // パワーアップアイテム用配列
        let clock;
        let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false;
        let playerSpeed = 0.15;
        let canShoot = true;
        let shootCooldown = 0.5; // 秒
        let lastShootTime = 0;
        let score = 0;
        let isGameOver = false;
        let isGameActive = false;
        let cameraShake = { active: false, intensity: 0, duration: 0, startTime: 0 }; // カメラシェイク用

        // 難易度設定
        let difficulty = {
            level: 1,
            maxLevel: 5,
            enemySpeed: 0.05,
            enemyFireRate: 0.01,
            scoreThreshold: 1000, // 次のレベルに進むスコア閾値
            lastLevelUpScore: 0
        };

        // プレイヤーの強化状態
        let playerPowerups = {
            rapidFire: { active: false, duration: 5, startTime: 0 }, // 連射
            tripleShot: { active: false, duration: 10, startTime: 0 }, // 3連射
            shield: { active: false, duration: 15, startTime: 0 },     // シールド
            bomb: { active: false, duration: 0, startTime: 0 },       // 爆弾（一回限りの効果）
            speedBoost: { active: false, duration: 8, startTime: 0 }, // 速度アップ
            health: { active: false, duration: 0, startTime: 0 }      // 体力回復（一回限りの効果）
        };

        // サウンドエフェクト
        let sounds = {
            bgm: null,
            shoot: null,
            explosion: null,
            powerup: null,
            gameOver: null,
            gameWin: null
        };

        // サウンド初期化
        function initSounds() {
            // BGM
            sounds.bgm = new Audio('https://assets.codepen.io/21542/TownTheme.mp3');
            sounds.bgm.loop = true;
            sounds.bgm.volume = 0.3;

            // 射撃音
            sounds.shoot = new Audio('https://assets.codepen.io/21542/shoot.mp3');
            sounds.shoot.volume = 0.2;

            // 爆発音
            sounds.explosion = new Audio('https://assets.codepen.io/21542/explosion.mp3');
            sounds.explosion.volume = 0.3;

            // パワーアップ取得音
            sounds.powerup = new Audio('https://assets.codepen.io/21542/powerup.mp3');
            sounds.powerup.volume = 0.4;

            // ゲームオーバー音
            sounds.gameOver = new Audio('https://assets.codepen.io/21542/gameover.mp3');
            sounds.gameOver.volume = 0.5;

            // ゲームクリア音
            sounds.gameWin = new Audio('https://assets.codepen.io/21542/win.mp3');
            sounds.gameWin.volume = 0.5;
        }

        // サウンド再生
        function playSound(soundName) {
            if (sounds[soundName]) {
                // 再生中なら巻き戻して再生
                sounds[soundName].currentTime = 0;
                sounds[soundName].play().catch(e => console.log("Sound play error:", e));
            }
        }

        // ゲーム初期化
        function init() {
            console.log('Game initialization started');
            isGameActive = true;
            score = 0;
            isGameOver = false;

            // サウンド初期化
            initSounds();

            // BGM再生
            playSound('bgm');

            // UI表示
            document.getElementById('gameTitle').style.display = 'none';
            document.getElementById('gameInstructions').style.display = 'block';
            document.getElementById('gameUI').style.display = 'block';
            document.getElementById('scoreDisplay').textContent = '0';
            document.getElementById('gameOver').style.display = 'none';

            // クロック初期化
            clock = new THREE.Clock();

            // シーン作成
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000000);
            scene.fog = new THREE.FogExp2(0x000000, 0.01);

            // カメラ設定
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 5, 10);

            // レンダラー設定
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            document.getElementById('game-container').appendChild(renderer.domElement);

            // プレイヤーコントロール設定 - OrbitControlsは使わない
            // 代わりにキーボード操作でプレイヤーを動かす

            // ライト設定
            const ambientLight = new THREE.AmbientLight(0x404040, 1);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(5, 10, 7.5);
            directionalLight.castShadow = true;
            scene.add(directionalLight);

            // 点滅するポイントライト
            const pointLight1 = new THREE.PointLight(0x4285f4, 1, 50);
            pointLight1.position.set(0, 15, 0);
            scene.add(pointLight1);

            const pointLight2 = new THREE.PointLight(0xff0000, 1, 30);
            pointLight2.position.set(-10, 5, 10);
            scene.add(pointLight2);

            const pointLight3 = new THREE.PointLight(0x00ff00, 1, 30);
            pointLight3.position.set(10, 5, 10);
            scene.add(pointLight3);

            // ライトのアニメーション
            function animateLights() {
                const time = Date.now() * 0.001;

                pointLight1.intensity = 1 + Math.sin(time) * 0.5;
                pointLight2.intensity = 1 + Math.sin(time * 1.1) * 0.5;
                pointLight3.intensity = 1 + Math.sin(time * 0.9) * 0.5;

                requestAnimationFrame(animateLights);
            }
            animateLights();

            // ゲームフィールドの作成
            const fieldSize = 50;
            const groundGeometry = new THREE.PlaneGeometry(fieldSize, fieldSize);
            const groundMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x222222,
                metalness: 0.8,
                roughness: 0.2
            });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);

            // グリッド
            const gridHelper = new THREE.GridHelper(fieldSize, fieldSize, 0x444444, 0x222222);
            scene.add(gridHelper);

            // 背景の星空
            createStars();

            // プレイヤーキャラクター（Kumayu）の読み込み
            const loader = new THREE.GLTFLoader();

            // 複数のパスを試す関数
            function tryLoadModel(paths, index) {
                if (index >= paths.length) {
                    console.error('すべてのパスでモデルの読み込みに失敗しました');
                    return;
                }

                console.log('モデルを読み込み中: ' + paths[index]);

                loader.load(paths[index], function(gltf) {
                    console.log('モデルの読み込みに成功しました: ' + paths[index]);
                    playerModel = gltf.scene;
                    playerModel.scale.set(1.0, 1.0, 1.0);
                    playerModel.rotation.y = Math.PI/2; // 90度回転
                    playerModel.position.set(0, 0, 0);
                    playerModel.castShadow = true;
                    playerModel.receiveShadow = true;

                    // プレイヤーオブジェクトの作成
                    player = new THREE.Object3D();
                    player.add(playerModel);
                    player.position.set(0, 0, 10);
                    scene.add(player);

                    // アニメーションミキサーの設定（リグが入っている場合）
                    if (gltf.animations && gltf.animations.length > 0) {
                        const mixer = new THREE.AnimationMixer(playerModel);
                        const idleAction = mixer.clipAction(gltf.animations[0]);
                        idleAction.play();

                        // アニメーション更新関数をアニメーションループに追加
                        player.mixer = mixer;
                    }

                    // 敵の作成
                    createEnemies();

                    // パーティクルシステム
                    createParticleSystem();

                    // キーボードイベントリスナーの設定
                    setupEventListeners();

                    // アニメーションループ開始
                    animate();
                }, undefined, function(error) {
                    console.error('パス ' + paths[index] + ' でのモデルの読み込みに失敗しました:', error);
                    // 次のパスを試す
                    tryLoadModel(paths, index + 1);
                });
            }

            // 試すパスの配列
            const modelPaths = [
                './Models/Kumayu.glb',
                '../special/Models/Kumayu.glb',
                'special/Models/Kumayu.glb',
                'Models/Kumayu.glb'
            ];

            // 最初のパスから試す
            tryLoadModel(modelPaths, 0);

            // ウィンドウリサイズ対応
            window.addEventListener('resize', onWindowResize);
        }

        // 星空の作成
        function createStars() {
            const starsGeometry = new THREE.BufferGeometry();
            const starsMaterial = new THREE.PointsMaterial({
                color: 0xffffff,
                size: 0.1,
                transparent: true
            });

            const starsVertices = [];
            for (let i = 0; i < 10000; i++) {
                const x = (Math.random() - 0.5) * 2000;
                const y = (Math.random() - 0.5) * 2000;
                const z = (Math.random() - 0.5) * 2000;
                starsVertices.push(x, y, z);
            }

            starsGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starsVertices, 3));
            const stars = new THREE.Points(starsGeometry, starsMaterial);
            scene.add(stars);
        }

        // 敵の作成
        function createEnemies() {
            // 敵の配置パターン（5行x8列）
            const rows = 5;
            const cols = 8;
            const spacing = 3;

            for (let row = 0; row < rows; row++) {
                for (let col = 0; col < cols; col++) {
                    // 敵のジオメトリとマテリアル
                    const geometry = new THREE.ConeGeometry(0.5, 1, 8);
                    const material = new THREE.MeshStandardMaterial({
                        color: 0xff0000,
                        emissive: 0x330000,
                        metalness: 0.8,
                        roughness: 0.2
                    });
                    const enemy = new THREE.Mesh(geometry, material);

                    // 位置の設定
                    enemy.position.x = (col - (cols - 1) / 2) * spacing;
                    enemy.position.y = 1;
                    enemy.position.z = -10 - row * spacing;
                    enemy.rotation.x = Math.PI; // 先端を下向きに

                    enemy.castShadow = true;
                    enemy.receiveShadow = true;

                    // 敵の移動パターン
                    enemy.direction = 1; // 1: 右, -1: 左
                    enemy.speed = difficulty.enemySpeed;
                    enemy.amplitude = 0.5; // 上下の揺れ幅
                    enemy.phaseOffset = Math.random() * Math.PI * 2; // 位相のずれ

                    // 敵の光
                    const enemyLight = new THREE.PointLight(0xff0000, 0.5, 2);
                    enemyLight.position.set(0, 0, 0);
                    enemy.add(enemyLight);

                    scene.add(enemy);
                    enemies.push(enemy);
                }
            }

            // 初期パワーアップをランダムに配置
            setTimeout(spawnPowerUp, 5000); // 5秒後に最初のパワーアップを出現
        }

        // ボスの作成
        function spawnBoss() {
            if (!isGameActive || isGameOver) return;

            // ボス出現の通知
            const bossWarning = document.createElement('div');
            bossWarning.style.position = 'fixed';
            bossWarning.style.top = '50%';
            bossWarning.style.left = '50%';
            bossWarning.style.transform = 'translate(-50%, -50%)';
            bossWarning.style.color = '#ff0000';
            bossWarning.style.fontSize = '48px';
            bossWarning.style.fontWeight = 'bold';
            bossWarning.style.textShadow = '0 0 10px #ff0000, 0 0 20px #ff0000';
            bossWarning.style.zIndex = '1000';
            bossWarning.style.pointerEvents = 'none';
            bossWarning.style.opacity = '1';
            bossWarning.style.transition = 'opacity 2s';
            bossWarning.textContent = 'ボス出現！！';

            document.body.appendChild(bossWarning);

            // 効果音
            playSound('explosion');

            // 画面シェイク
            shakeCamera(1.0, 1.0);

            // 2秒後にフェードアウト
            setTimeout(() => {
                bossWarning.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(bossWarning);
                }, 2000);
            }, 2000);

            // ボスのジオメトリとマテリアル
            const geometry = new THREE.SphereGeometry(3, 32, 32);
            const material = new THREE.MeshStandardMaterial({
                color: 0xff0000,
                emissive: 0x550000,
                metalness: 0.9,
                roughness: 0.1
            });
            const boss = new THREE.Mesh(geometry, material);

            // 位置の設定
            boss.position.x = 0;
            boss.position.y = 3;
            boss.position.z = -30;

            boss.castShadow = true;
            boss.receiveShadow = true;

            // ボスの特性
            boss.isBoss = true;
            boss.health = 20; // 20回ヒットで倒せる
            boss.maxHealth = 20;
            boss.attackCooldown = 1.0; // 攻撃間隔（秒）
            boss.lastAttackTime = 0;
            boss.attackPattern = 0; // 攻撃パターン（0: 通常, 1: 拡散, 2: レーザー）
            boss.phaseThresholds = [0.7, 0.4, 0.1]; // 各フェーズの閾値（残り体力の割合）
            boss.currentPhase = 0;

            // ボスの移動パターン
            boss.direction = 1; // 1: 右, -1: 左
            boss.speed = 0.1;
            boss.amplitude = 0.5; // 上下の揺れ幅
            boss.phaseOffset = Math.random() * Math.PI * 2; // 位相のずれ

            // ボスの光
            const bossLight = new THREE.PointLight(0xff0000, 2, 10);
            bossLight.position.set(0, 0, 0);
            boss.add(bossLight);

            // ボスの装飾（触手）
            const tentacleCount = 8;
            for (let i = 0; i < tentacleCount; i++) {
                const angle = (i / tentacleCount) * Math.PI * 2;
                const tentacleGeometry = new THREE.CylinderGeometry(0.3, 0.1, 2, 8);
                const tentacleMaterial = new THREE.MeshStandardMaterial({
                    color: 0xff0000,
                    emissive: 0x330000,
                    metalness: 0.8,
                    roughness: 0.2
                });
                const tentacle = new THREE.Mesh(tentacleGeometry, tentacleMaterial);

                // 触手の位置と回転
                tentacle.position.x = Math.sin(angle) * 3;
                tentacle.position.z = Math.cos(angle) * 3;
                tentacle.rotation.x = Math.PI / 2;
                tentacle.rotation.z = angle;

                boss.add(tentacle);

                // 触手の先端に光
                const tentacleLight = new THREE.PointLight(0xff0000, 0.5, 2);
                tentacleLight.position.set(0, -1, 0);
                tentacle.add(tentacleLight);
            }

            scene.add(boss);
            enemies.push(boss);

            // ボスのヘルスバーUIを作成
            createBossHealthBar();
        }

        // ボスのヘルスバーUIを作成
        function createBossHealthBar() {
            const bossHealthBarContainer = document.createElement('div');
            bossHealthBarContainer.id = 'bossHealthBarContainer';
            bossHealthBarContainer.style.position = 'fixed';
            bossHealthBarContainer.style.bottom = '20px';
            bossHealthBarContainer.style.left = '50%';
            bossHealthBarContainer.style.transform = 'translateX(-50%)';
            bossHealthBarContainer.style.width = '80%';
            bossHealthBarContainer.style.height = '20px';
            bossHealthBarContainer.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            bossHealthBarContainer.style.borderRadius = '10px';
            bossHealthBarContainer.style.overflow = 'hidden';
            bossHealthBarContainer.style.zIndex = '100';

            const bossHealthBar = document.createElement('div');
            bossHealthBar.id = 'bossHealthBar';
            bossHealthBar.style.width = '100%';
            bossHealthBar.style.height = '100%';
            bossHealthBar.style.backgroundColor = '#ff0000';
            bossHealthBar.style.background = 'linear-gradient(to right, #ff0000, #ff5500)';
            bossHealthBar.style.transition = 'width 0.3s';

            const bossHealthLabel = document.createElement('div');
            bossHealthLabel.style.position = 'absolute';
            bossHealthLabel.style.top = '0';
            bossHealthLabel.style.left = '10px';
            bossHealthLabel.style.color = 'white';
            bossHealthLabel.style.fontSize = '14px';
            bossHealthLabel.style.lineHeight = '20px';
            bossHealthLabel.style.fontWeight = 'bold';
            bossHealthLabel.style.textShadow = '1px 1px 2px black';
            bossHealthLabel.textContent = 'ボス';

            bossHealthBarContainer.appendChild(bossHealthBar);
            bossHealthBarContainer.appendChild(bossHealthLabel);
            document.body.appendChild(bossHealthBarContainer);
        }

        // ボスのヘルスバーを更新
        function updateBossHealthBar() {
            const boss = enemies.find(enemy => enemy.isBoss);
            if (!boss) return;

            const healthPercentage = (boss.health / boss.maxHealth) * 100;
            const bossHealthBar = document.getElementById('bossHealthBar');
            if (bossHealthBar) {
                bossHealthBar.style.width = `${healthPercentage}%`;
            }
        }

        // パワーアップの作成
        function spawnPowerUp() {
            if (!isGameActive || isGameOver) return;

            // パワーアップの種類をランダムに選択
            const types = ['rapidFire', 'tripleShot', 'shield', 'bomb', 'speedBoost', 'health'];
            const type = types[Math.floor(Math.random() * types.length)];

            // パワーアップのジオメトリとマテリアル
            const geometry = new THREE.OctahedronGeometry(0.5, 0);

            let color, emissive;
            switch(type) {
                case 'rapidFire':
                    color = 0xff5500;    // オレンジ
                    emissive = 0x551100;
                    break;
                case 'tripleShot':
                    color = 0x00ffff;    // シアン
                    emissive = 0x005555;
                    break;
                case 'shield':
                    color = 0x00ff00;    // 緑
                    emissive = 0x005500;
                    break;
                case 'bomb':
                    color = 0xff0000;    // 赤
                    emissive = 0x550000;
                    break;
                case 'speedBoost':
                    color = 0xffff00;    // 黄色
                    emissive = 0x555500;
                    break;
                case 'health':
                    color = 0xff00ff;    // ピンク
                    emissive = 0x550055;
                    break;
            }

            const material = new THREE.MeshStandardMaterial({
                color: color,
                emissive: emissive,
                metalness: 1.0,
                roughness: 0.2,
                transparent: true,
                opacity: 0.9
            });

            const powerUp = new THREE.Mesh(geometry, material);

            // ランダムな位置（プレイエリア内）
            powerUp.position.x = (Math.random() - 0.5) * 30;
            powerUp.position.y = 1;
            powerUp.position.z = (Math.random() - 0.5) * 30;

            // 回転アニメーション用のプロパティ
            powerUp.rotationSpeed = {
                x: Math.random() * 0.05,
                y: Math.random() * 0.05,
                z: Math.random() * 0.05
            };

            // 浮遊アニメーション用のプロパティ
            powerUp.floatSpeed = 0.01 + Math.random() * 0.01;
            powerUp.floatHeight = 0.5;
            powerUp.floatOffset = Math.random() * Math.PI * 2;

            // パワーアップの種類を保存
            powerUp.powerUpType = type;

            // 光源を追加
            const light = new THREE.PointLight(color, 1, 5);
            light.position.set(0, 0, 0);
            powerUp.add(light);

            scene.add(powerUp);
            powerUps.push(powerUp);

            // 次のパワーアップをスケジュール（10〜20秒後）
            const nextSpawnTime = 10000 + Math.random() * 10000;
            setTimeout(spawnPowerUp, nextSpawnTime);
        }

        // 弾の作成（最適化版）
        // 共有ジオメトリを使用
        const bulletGeometry = new THREE.SphereGeometry(0.2, 6, 6);

        function createBullet(isPlayerBullet, sourceEnemy = null, offsetX = 0, offsetZ = 0, velocityX = 0, velocityZ = 1) {
            const material = new THREE.MeshStandardMaterial({
                color: isPlayerBullet ? 0x00ffff : 0xff0000,
                emissive: isPlayerBullet ? 0x00aaaa : 0xaa0000,
                metalness: 1,
                roughness: 0
            });
            const bullet = new THREE.Mesh(bulletGeometry, material);

            if (isPlayerBullet) {
                // プレイヤーの弾
                bullet.position.copy(player.position);
                bullet.position.y += 0.5;
                bullet.position.x += offsetX;
                bullet.position.z += offsetZ;
                bullet.velocity = new THREE.Vector3(velocityX, 0, -1);
                bullet.isPlayerBullet = true;
            } else {
                // 敵の弾
                let enemy;
                if (sourceEnemy) {
                    // 指定された敵から発射
                    enemy = sourceEnemy;
                } else {
                    // ランダムな敵から発射
                    enemy = enemies[Math.floor(Math.random() * enemies.length)];
                }

                bullet.position.copy(enemy.position);
                bullet.position.x += offsetX;
                bullet.position.z += offsetZ;

                // ボスの弾は大きくする
                if (enemy.isBoss) {
                    bullet.scale.set(1.5, 1.5, 1.5);

                    // ボスのフェーズに応じて弾の色を変える
                    switch(enemy.attackPattern) {
                        case 1:
                            material.color.set(0xff6600);
                            material.emissive.set(0x551100);
                            break;
                        case 2:
                            material.color.set(0xffff00);
                            material.emissive.set(0x555500);
                            break;
                        case 3:
                            material.color.set(0xffffff);
                            material.emissive.set(0x555555);
                            break;
                    }
                }

                bullet.velocity = new THREE.Vector3(velocityX, 0, velocityZ);
                bullet.isPlayerBullet = false;
            }

            // 弾の光 - ボスの弾と特定の条件でのみ光を追加（パフォーマンス向上）
            if (sourceEnemy && sourceEnemy.isBoss) {
                const bulletLight = new THREE.PointLight(material.color, 1, 3);
                bulletLight.position.set(0, 0, 0);
                bullet.add(bulletLight);
            } else if (isPlayerBullet) {
                // プレイヤーの弾にも光を追加（ゲーム性を維持）
                const bulletLight = new THREE.PointLight(material.color, 0.7, 2);
                bulletLight.position.set(0, 0, 0);
                bullet.add(bulletLight);
            }

            scene.add(bullet);
            bullets.push(bullet);

            return bullet;
        }

        // 射撃処理
        function shoot() {
            if (!canShoot || !isGameActive || isGameOver) return;

            if (playerPowerups.tripleShot.active) {
                // 3連射モード
                createBullet(true, -0.5, 0, -0.1);  // 左
                createBullet(true);                 // 中央
                createBullet(true, 0.5, 0, 0.1);    // 右
            } else {
                // 通常射撃
                createBullet(true);
            }

            // 射撃音
            playSound('shoot');

            canShoot = false;
            lastShootTime = clock.getElapsedTime();

            // 射撃エフェクト
            const muzzleFlash = new THREE.PointLight(0x00ffff, 2, 5);
            muzzleFlash.position.copy(player.position);
            muzzleFlash.position.z -= 1;
            scene.add(muzzleFlash);

            // 0.1秒後に消える
            setTimeout(() => {
                scene.remove(muzzleFlash);
            }, 100);
        }

        // パーティクルシステムの作成
        function createParticleSystem() {
            for (let i = 0; i < 100; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                document.body.appendChild(particle);

                // ランダムな位置と速度
                const position = {
                    x: Math.random() * window.innerWidth,
                    y: Math.random() * window.innerHeight
                };

                const velocity = {
                    x: (Math.random() - 0.5) * 2,
                    y: (Math.random() - 0.5) * 2
                };

                particle.style.left = position.x + 'px';
                particle.style.top = position.y + 'px';

                particles.push({
                    element: particle,
                    position: position,
                    velocity: velocity,
                    size: Math.random() * 5 + 2
                });
            }
        }

        // パーティクルのアニメーション
        function animateParticles() {
            particles.forEach(particle => {
                // 位置の更新
                particle.position.x += particle.velocity.x;
                particle.position.y += particle.velocity.y;

                // 画面外に出たら反対側から再登場
                if (particle.position.x < 0) particle.position.x = window.innerWidth;
                if (particle.position.x > window.innerWidth) particle.position.x = 0;
                if (particle.position.y < 0) particle.position.y = window.innerHeight;
                if (particle.position.y > window.innerHeight) particle.position.y = 0;

                // DOMの更新
                particle.element.style.left = particle.position.x + 'px';
                particle.element.style.top = particle.position.y + 'px';
                particle.element.style.width = particle.size + 'px';
                particle.element.style.height = particle.size + 'px';
            });
        }

        // ウィンドウリサイズ対応
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // キーボードイベントリスナーの設定
        function setupEventListeners() {
            // キーダウンイベント
            document.addEventListener('keydown', function(event) {
                switch(event.code) {
                    case 'KeyW':
                        moveForward = true;
                        break;
                    case 'KeyS':
                        moveBackward = true;
                        break;
                    case 'KeyA':
                        moveLeft = true;
                        break;
                    case 'KeyD':
                        moveRight = true;
                        break;
                    case 'Space':
                        // スペースキーで射撃
                        shoot();
                        break;
                }
            });

            // キーアップイベント
            document.addEventListener('keyup', function(event) {
                switch(event.code) {
                    case 'KeyW':
                        moveForward = false;
                        break;
                    case 'KeyS':
                        moveBackward = false;
                        break;
                    case 'KeyA':
                        moveLeft = false;
                        break;
                    case 'KeyD':
                        moveRight = false;
                        break;
                }
            });

            // リスタートボタンのイベント
            document.getElementById('restartButton').addEventListener('click', function() {
                // ゲームをリセットして再開
                resetGame();
            });
        }

        // ゲームリセット
        function resetGame() {
            // 既存のオブジェクトをクリア
            while(scene.children.length > 0) { 
                scene.remove(scene.children[0]); 
            }

            enemies = [];
            bullets = [];

            // パーティクルを削除
            particles.forEach(particle => {
                document.body.removeChild(particle.element);
            });
            particles = [];

            // ゲームを再初期化
            init();
        }

        // パワーアップ効果の更新
        function updatePowerupEffects(currentTime) {
            // 連射パワーアップ
            if (playerPowerups.rapidFire.active) {
                if (currentTime - playerPowerups.rapidFire.startTime > playerPowerups.rapidFire.duration) {
                    playerPowerups.rapidFire.active = false;
                    shootCooldown = 0.5; // 通常の射撃速度に戻す
                    updatePowerupUI();
                }
            }

            // 3連射パワーアップ
            if (playerPowerups.tripleShot.active) {
                if (currentTime - playerPowerups.tripleShot.startTime > playerPowerups.tripleShot.duration) {
                    playerPowerups.tripleShot.active = false;
                    updatePowerupUI();
                }
            }

            // シールドパワーアップ
            if (playerPowerups.shield.active) {
                if (currentTime - playerPowerups.shield.startTime > playerPowerups.shield.duration) {
                    playerPowerups.shield.active = false;
                    // シールドの視覚効果を削除
                    if (player.shield) {
                        player.remove(player.shield);
                        player.shield = null;
                    }
                    updatePowerupUI();
                }
            }

            // スピードブーストパワーアップ
            if (playerPowerups.speedBoost.active) {
                if (currentTime - playerPowerups.speedBoost.startTime > playerPowerups.speedBoost.duration) {
                    playerPowerups.speedBoost.active = false;
                    playerSpeed = 0.15; // 通常の移動速度に戻す

                    // スピードエフェクトを削除
                    if (player.speedTrail) {
                        player.remove(player.speedTrail);
                        player.speedTrail = null;
                    }

                    updatePowerupUI();
                }
            }
        }

        // パワーアップUIの更新
        function updatePowerupUI() {
            const time = clock.getElapsedTime();

            // パワーアップアイコンの更新
            const powerupUI = document.getElementById('powerupUI');
            if (!powerupUI) return;

            powerupUI.innerHTML = '';

            if (playerPowerups.rapidFire.active) {
                const rapidFireIcon = document.createElement('div');
                rapidFireIcon.className = 'powerup-icon rapid-fire';
                rapidFireIcon.innerHTML = '🔥';
                rapidFireIcon.title = '連射モード';
                powerupUI.appendChild(rapidFireIcon);
            }

            if (playerPowerups.tripleShot.active) {
                const tripleShotIcon = document.createElement('div');
                tripleShotIcon.className = 'powerup-icon triple-shot';
                tripleShotIcon.innerHTML = '🔱';
                tripleShotIcon.title = '3連射モード';
                powerupUI.appendChild(tripleShotIcon);
            }

            if (playerPowerups.shield.active) {
                const shieldIcon = document.createElement('div');
                shieldIcon.className = 'powerup-icon shield';
                shieldIcon.innerHTML = '🛡️';
                shieldIcon.title = 'シールド';
                powerupUI.appendChild(shieldIcon);
            }

            if (playerPowerups.speedBoost.active) {
                const speedBoostIcon = document.createElement('div');
                speedBoostIcon.className = 'powerup-icon speed-boost';
                speedBoostIcon.style.backgroundColor = 'rgba(255, 255, 0, 0.3)';
                speedBoostIcon.style.boxShadow = '0 0 10px rgba(255, 255, 0, 0.8)';
                speedBoostIcon.innerHTML = '⚡';
                speedBoostIcon.title = 'スピードアップ';
                powerupUI.appendChild(speedBoostIcon);
            }

            // パワーアップタイマーの更新
            const powerupTimers = document.getElementById('powerupTimers');
            if (!powerupTimers) return;

            powerupTimers.innerHTML = '';

            // 連射タイマー
            if (playerPowerups.rapidFire.active) {
                const remainingTime = playerPowerups.rapidFire.duration - (time - playerPowerups.rapidFire.startTime);
                const percentage = (remainingTime / playerPowerups.rapidFire.duration) * 100;

                const timerContainer = document.createElement('div');
                timerContainer.className = 'timer-bar-container timer-rapid-fire';

                const timerBar = document.createElement('div');
                timerBar.className = 'timer-bar';
                timerBar.style.width = `${percentage}%`;

                const timerLabel = document.createElement('div');
                timerLabel.className = 'timer-label';
                timerLabel.textContent = '連射モード';

                timerContainer.appendChild(timerBar);
                timerContainer.appendChild(timerLabel);
                powerupTimers.appendChild(timerContainer);
            }

            // 3連射タイマー
            if (playerPowerups.tripleShot.active) {
                const remainingTime = playerPowerups.tripleShot.duration - (time - playerPowerups.tripleShot.startTime);
                const percentage = (remainingTime / playerPowerups.tripleShot.duration) * 100;

                const timerContainer = document.createElement('div');
                timerContainer.className = 'timer-bar-container timer-triple-shot';

                const timerBar = document.createElement('div');
                timerBar.className = 'timer-bar';
                timerBar.style.width = `${percentage}%`;

                const timerLabel = document.createElement('div');
                timerLabel.className = 'timer-label';
                timerLabel.textContent = '3連射モード';

                timerContainer.appendChild(timerBar);
                timerContainer.appendChild(timerLabel);
                powerupTimers.appendChild(timerContainer);
            }

            // シールドタイマー
            if (playerPowerups.shield.active) {
                const remainingTime = playerPowerups.shield.duration - (time - playerPowerups.shield.startTime);
                const percentage = (remainingTime / playerPowerups.shield.duration) * 100;

                const timerContainer = document.createElement('div');
                timerContainer.className = 'timer-bar-container timer-shield';

                const timerBar = document.createElement('div');
                timerBar.className = 'timer-bar';
                timerBar.style.width = `${percentage}%`;

                const timerLabel = document.createElement('div');
                timerLabel.className = 'timer-label';
                timerLabel.textContent = 'シールド';

                timerContainer.appendChild(timerBar);
                timerContainer.appendChild(timerLabel);
                powerupTimers.appendChild(timerContainer);
            }

            // スピードブーストタイマー
            if (playerPowerups.speedBoost.active) {
                const remainingTime = playerPowerups.speedBoost.duration - (time - playerPowerups.speedBoost.startTime);
                const percentage = (remainingTime / playerPowerups.speedBoost.duration) * 100;

                const timerContainer = document.createElement('div');
                timerContainer.className = 'timer-bar-container timer-speed-boost';

                const timerBar = document.createElement('div');
                timerBar.className = 'timer-bar';
                timerBar.style.width = `${percentage}%`;
                timerBar.style.background = 'linear-gradient(to right, #ffff00, #ffaa00)';

                const timerLabel = document.createElement('div');
                timerLabel.className = 'timer-label';
                timerLabel.textContent = 'スピードアップ';

                timerContainer.appendChild(timerBar);
                timerContainer.appendChild(timerLabel);
                powerupTimers.appendChild(timerContainer);
            }
        }

        // パワーアップの適用
        function applyPowerup(type) {
            const time = clock.getElapsedTime();

            switch(type) {
                case 'rapidFire':
                    playerPowerups.rapidFire.active = true;
                    playerPowerups.rapidFire.startTime = time;
                    shootCooldown = 0.1; // 射撃速度アップ
                    createScorePopup("連射モード!", player.position);
                    break;

                case 'tripleShot':
                    playerPowerups.tripleShot.active = true;
                    playerPowerups.tripleShot.startTime = time;
                    createScorePopup("3連射モード!", player.position);
                    break;

                case 'shield':
                    playerPowerups.shield.active = true;
                    playerPowerups.shield.startTime = time;

                    // シールドの視覚効果
                    if (!player.shield) {
                        const shieldGeometry = new THREE.SphereGeometry(1.2, 16, 16);
                        const shieldMaterial = new THREE.MeshBasicMaterial({
                            color: 0x00ff00,
                            transparent: true,
                            opacity: 0.3,
                            side: THREE.DoubleSide
                        });
                        player.shield = new THREE.Mesh(shieldGeometry, shieldMaterial);
                        player.add(player.shield);

                        // シールドの光
                        const shieldLight = new THREE.PointLight(0x00ff00, 1, 5);
                        player.shield.add(shieldLight);
                    }

                    createScorePopup("シールド発動!", player.position);
                    break;

                case 'bomb':
                    // 画面上の全ての敵を爆発させる
                    const enemiesClone = [...enemies]; // 配列のコピーを作成（削除中に配列が変更されるため）
                    enemiesClone.forEach(enemy => {
                        // 爆発エフェクト
                        createExplosion(enemy.position.clone());

                        // 敵を削除
                        scene.remove(enemy);
                        const index = enemies.indexOf(enemy);
                        if (index > -1) {
                            enemies.splice(index, 1);
                        }

                        // スコア加算
                        score += 100;
                    });

                    // スコア表示を更新
                    document.getElementById('scoreDisplay').textContent = score;

                    // 画面シェイク
                    shakeCamera(1.0, 1.0);

                    // 通知
                    createScorePopup("ボム発動！全滅！", player.position);

                    // 全ての敵を倒したらゲームクリア
                    if (enemies.length === 0) {
                        // ボスを出現させる
                        setTimeout(spawnBoss, 3000);
                    }
                    break;

                case 'speedBoost':
                    playerPowerups.speedBoost.active = true;
                    playerPowerups.speedBoost.startTime = time;

                    // プレイヤーの移動速度を2倍に
                    playerSpeed = 0.3;

                    // 通知
                    createScorePopup("スピードアップ！", player.position);

                    // エフェクト
                    const speedTrail = new THREE.PointLight(0xffff00, 1, 3);
                    speedTrail.position.set(0, 0, 0);
                    player.add(speedTrail);
                    player.speedTrail = speedTrail;
                    break;

                case 'health':
                    // プレイヤーの体力回復（ここでは無敵時間を付与する）
                    playerPowerups.shield.active = true;
                    playerPowerups.shield.startTime = time;
                    playerPowerups.shield.duration = 5; // 5秒間の無敵時間

                    // 回復エフェクト
                    const healEffect = new THREE.PointLight(0xff00ff, 2, 10);
                    healEffect.position.copy(player.position);
                    scene.add(healEffect);

                    // 2秒後に消える
                    setTimeout(() => {
                        scene.remove(healEffect);
                    }, 2000);

                    // 通知
                    createScorePopup("回復！一時無敵！", player.position);
                    break;
            }

            updatePowerupUI();
        }

        // 衝突判定（最適化コメント：パフォーマンス向上のため、一部処理を最適化）
        function checkCollisions() {
            // プレイヤーと敵の弾の衝突
            bullets.forEach((bullet, bulletIndex) => {
                // 画面外の弾は衝突判定をスキップ（最適化）
                if (bullet.position.z < -40 || bullet.position.z > 40 || 
                    bullet.position.x < -40 || bullet.position.x > 40) {
                    return;
                }

                if (!bullet.isPlayerBullet) {
                    // プレイヤーとの距離を計算
                    const distance = bullet.position.distanceTo(player.position);
                    if (distance < 1) {
                        // プレイヤーがヒット
                        scene.remove(bullet);
                        bullets.splice(bulletIndex, 1);

                        // シールドがあれば防御
                        if (playerPowerups.shield.active) {
                            // シールドエフェクト
                            createScorePopup("シールド防御!", player.position);
                            shakeCamera(0.2, 0.2);
                            return;
                        }

                        // 画面シェイク効果
                        shakeCamera(0.5, 0.5);

                        // ダメージエフェクト
                        createDamageEffect();

                        // ゲームオーバー
                        gameOver();
                        return;
                    }
                } else {
                    // プレイヤーの弾と敵の衝突
                    enemies.forEach((enemy, enemyIndex) => {
                        // 遠くの敵はスキップ（大まかな距離チェック - 最適化）
                        if (Math.abs(bullet.position.z - enemy.position.z) > 10) {
                            return; // この敵をスキップ
                        }

                        const distance = bullet.position.distanceTo(enemy.position);
                        const hitSize = enemy.isBoss ? 3 : 1; // ボスは当たり判定が大きい

                        if (distance < hitSize) {
                            // 弾を削除
                            scene.remove(bullet);
                            bullets.splice(bulletIndex, 1);

                            if (enemy.isBoss) {
                                // ボスがヒット
                                enemy.health -= 1;

                                // ヘルスバーを更新
                                updateBossHealthBar();

                                // ヒットエフェクト（小さな爆発）
                                const hitPosition = bullet.position.clone();
                                createExplosion(hitPosition);

                                // ヒット音
                                playSound('explosion');

                                // スコア加算
                                score += 50;
                                document.getElementById('scoreDisplay').textContent = score;

                                // スコアポップアップエフェクト
                                createScorePopup("+50", hitPosition);

                                // 小さな画面シェイク
                                shakeCamera(0.1, 0.1);

                                // ボスのフェーズチェック
                                const healthRatio = enemy.health / enemy.maxHealth;
                                for (let i = enemy.currentPhase; i < enemy.phaseThresholds.length; i++) {
                                    if (healthRatio <= enemy.phaseThresholds[i]) {
                                        enemy.currentPhase = i + 1;

                                        // フェーズ変更通知
                                        createScorePopup("ボスが怒った！", enemy.position);

                                        // 攻撃パターン変更
                                        enemy.attackPattern = enemy.currentPhase;

                                        // ボスの色を変更
                                        switch(enemy.currentPhase) {
                                            case 1:
                                                enemy.material.color.set(0xff6600); // オレンジ
                                                enemy.material.emissive.set(0x551100);
                                                break;
                                            case 2:
                                                enemy.material.color.set(0xffff00); // 黄色
                                                enemy.material.emissive.set(0x555500);
                                                break;
                                            case 3:
                                                enemy.material.color.set(0xffffff); // 白
                                                enemy.material.emissive.set(0x555555);
                                                break;
                                        }

                                        // 大きな画面シェイク
                                        shakeCamera(0.5, 0.5);

                                        break;
                                    }
                                }

                                // ボスを倒した場合
                                if (enemy.health <= 0) {
                                    // 大爆発エフェクト - 回数を減らして最適化
                                    for (let i = 0; i < 5; i++) { // 10から5に削減
                                        setTimeout(() => {
                                            const offset = new THREE.Vector3(
                                                (Math.random() - 0.5) * 5,
                                                (Math.random() - 0.5) * 5,
                                                (Math.random() - 0.5) * 5
                                            );
                                            createExplosion(enemy.position.clone().add(offset));
                                        }, i * 300); // タイミングも少し広げる
                                    }

                                    // ボスを削除
                                    scene.remove(enemy);
                                    enemies.splice(enemyIndex, 1);

                                    // ヘルスバーを削除
                                    const healthBar = document.getElementById('bossHealthBarContainer');
                                    if (healthBar) {
                                        document.body.removeChild(healthBar);
                                    }

                                    // 大きな画面シェイク
                                    shakeCamera(1.0, 1.0);

                                    // スコア加算
                                    score += 5000;
                                    document.getElementById('scoreDisplay').textContent = score;

                                    // スコアポップアップエフェクト
                                    createScorePopup("+5000 ボス撃破！", enemy.position);

                                    // ゲームクリア
                                    setTimeout(() => {
                                        gameWin();
                                    }, 2000);
                                }
                            } else {
                                // 通常の敵がヒット
                                // 爆発エフェクト
                                createExplosion(enemy.position.clone());

                                // 敵を削除
                                scene.remove(enemy);
                                enemies.splice(enemyIndex, 1);

                                // スコア加算
                                score += 100;
                                document.getElementById('scoreDisplay').textContent = score;

                                // スコアポップアップエフェクト
                                createScorePopup("+100", enemy.position);

                                // 全ての敵を倒したらボス出現
                                if (enemies.length === 0) {
                                    setTimeout(spawnBoss, 3000);
                                }
                            }
                            return;
                        }
                    });
                }
            });

            // プレイヤーとパワーアップの衝突
            if (player) {
                powerUps.forEach((powerUp, index) => {
                    const distance = powerUp.position.distanceTo(player.position);
                    if (distance < 1.5) {
                        // パワーアップ取得
                        scene.remove(powerUp);
                        powerUps.splice(index, 1);

                        // パワーアップ音
                        playSound('powerup');

                        // パワーアップ効果適用
                        applyPowerup(powerUp.powerUpType);

                        // 取得エフェクト
                        createExplosion(powerUp.position.clone());
                    }
                });
            }
        }

        // ゲームオーバー処理
        function gameOver() {
            isGameOver = true;
            isGameActive = false;

            // BGM停止
            if (sounds.bgm) {
                sounds.bgm.pause();
                sounds.bgm.currentTime = 0;
            }

            // ゲームオーバー音
            playSound('gameOver');

            document.getElementById('finalScore').textContent = score;
            document.getElementById('gameOver').style.display = 'block';
        }

        // ゲームクリア処理
        function gameWin() {
            isGameOver = true;
            isGameActive = false;

            // BGM停止
            if (sounds.bgm) {
                sounds.bgm.pause();
                sounds.bgm.currentTime = 0;
            }

            // ゲームクリア音
            playSound('gameWin');

            document.getElementById('gameOver').querySelector('div:first-child').textContent = 'ゲームクリア！';
            document.getElementById('finalScore').textContent = score;
            document.getElementById('gameOver').style.display = 'block';
        }

        // カメラシェイク効果
        function shakeCamera(intensity, duration) {
            cameraShake.active = true;
            cameraShake.intensity = intensity;
            cameraShake.duration = duration;
            cameraShake.startTime = clock.getElapsedTime();
        }

        // カメラシェイクの更新
        function updateCameraShake() {
            if (!cameraShake.active) return;

            const currentTime = clock.getElapsedTime();
            const elapsedTime = currentTime - cameraShake.startTime;

            if (elapsedTime > cameraShake.duration) {
                cameraShake.active = false;
                camera.position.x = player.position.x;
                camera.position.y = player.position.y + 2;
                camera.position.z = player.position.z + 2;
                return;
            }

            // 残り時間に基づいて強度を減衰
            const remainingFactor = 1 - (elapsedTime / cameraShake.duration);
            const currentIntensity = cameraShake.intensity * remainingFactor;

            // ランダムなオフセットを適用
            camera.position.x = player.position.x + (Math.random() - 0.5) * currentIntensity;
            camera.position.y = player.position.y + 2 + (Math.random() - 0.5) * currentIntensity;
            camera.position.z = player.position.z + 2 + (Math.random() - 0.5) * currentIntensity;
        }

        // ダメージエフェクト
        function createDamageEffect() {
            // 画面を一瞬赤く点滅させる
            const overlay = document.createElement('div');
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.backgroundColor = 'rgba(255, 0, 0, 0.3)';
            overlay.style.pointerEvents = 'none';
            overlay.style.zIndex = '1000';
            overlay.style.transition = 'opacity 0.5s';

            document.body.appendChild(overlay);

            // フェードアウト
            setTimeout(() => {
                overlay.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(overlay);
                }, 500);
            }, 100);
        }

        // 爆発エフェクト
        function createExplosion(position) {
            // 爆発音
            playSound('explosion');

            // 爆発のパーティクル数を減らして最適化
            const particleCount = 10; // 20から10に削減
            const explosionGroup = new THREE.Group();
            explosionGroup.position.copy(position);

            // 爆発の中心の光
            const light = new THREE.PointLight(0xff9900, 2, 10);
            light.position.set(0, 0, 0);
            explosionGroup.add(light);

            // 共有ジオメトリとマテリアルを使用して最適化
            const geometry = new THREE.SphereGeometry(0.2, 6, 6); // 解像度も下げる

            // パーティクル
            for (let i = 0; i < particleCount; i++) {
                const material = new THREE.MeshBasicMaterial({
                    color: new THREE.Color(
                        Math.random() * 0.2 + 0.8, // R: 赤～オレンジ
                        Math.random() * 0.5,       // G: 少し緑
                        0                          // B: 青なし
                    ),
                    transparent: true,
                    opacity: 1
                });

                const particle = new THREE.Mesh(geometry, material);
                const scale = Math.random() * 0.5 + 0.5;
                particle.scale.set(scale, scale, scale);

                // ランダムな方向と速度
                const speed = Math.random() * 4 + 2; // 速度範囲も少し狭く
                particle.velocity = new THREE.Vector3(
                    (Math.random() - 0.5) * speed,
                    (Math.random() - 0.5) * speed,
                    (Math.random() - 0.5) * speed
                );

                particle.lifespan = Math.random() * 0.4 + 0.3; // 寿命を少し短く
                particle.age = 0;

                explosionGroup.add(particle);
            }

            scene.add(explosionGroup);
            explosions.push({
                group: explosionGroup,
                age: 0,
                duration: 1.0 // 爆発の持続時間（秒）
            });

            // 小さな画面シェイク
            shakeCamera(0.2, 0.2);
        }

        // 爆発エフェクトの更新
        function updateExplosions(delta) {
            for (let i = explosions.length - 1; i >= 0; i--) {
                const explosion = explosions[i];
                explosion.age += delta;

                if (explosion.age >= explosion.duration) {
                    // 爆発の寿命が尽きたら削除
                    scene.remove(explosion.group);
                    explosions.splice(i, 1);
                    continue;
                }

                // 進行度（0～1）
                const progress = explosion.age / explosion.duration;

                // 爆発の光の強度を減衰
                const light = explosion.group.children[0];
                light.intensity = 2 * (1 - progress);

                // パーティクルの更新
                for (let j = 1; j < explosion.group.children.length; j++) {
                    const particle = explosion.group.children[j];

                    // 位置の更新
                    particle.position.add(particle.velocity.clone().multiplyScalar(delta));

                    // 速度の減衰
                    particle.velocity.multiplyScalar(0.95);

                    // 年齢の更新
                    particle.age += delta;

                    // 透明度の更新（徐々に消える）
                    if (particle.age >= particle.lifespan) {
                        particle.material.opacity = 0;
                    } else {
                        particle.material.opacity = 1 - (particle.age / particle.lifespan);
                    }

                    // サイズの更新（徐々に小さくなる）
                    const scale = 1 - (particle.age / particle.lifespan) * 0.5;
                    particle.scale.set(scale, scale, scale);
                }
            }
        }

        // スコアポップアップエフェクト
        function createScorePopup(text, position) {
            // 3D空間上のスコアテキスト
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = 128;
            canvas.height = 64;

            context.fillStyle = 'rgba(0, 0, 0, 0)';
            context.fillRect(0, 0, canvas.width, canvas.height);

            context.font = 'bold 36px Arial';
            context.textAlign = 'center';
            context.textBaseline = 'middle';

            // グラデーションテキスト
            const gradient = context.createLinearGradient(0, 0, canvas.width, 0);
            gradient.addColorStop(0, '#ffff00');
            gradient.addColorStop(0.5, '#ffffff');
            gradient.addColorStop(1, '#ffff00');
            context.fillStyle = gradient;

            context.fillText(text, canvas.width / 2, canvas.height / 2);

            // テクスチャとスプライト作成
            const texture = new THREE.CanvasTexture(canvas);
            const material = new THREE.SpriteMaterial({
                map: texture,
                transparent: true,
                opacity: 1
            });

            const sprite = new THREE.Sprite(material);
            sprite.position.copy(position);
            sprite.position.y += 1; // 少し上に表示
            sprite.scale.set(2, 1, 1);

            scene.add(sprite);

            scorePopups.push({
                sprite: sprite,
                age: 0,
                duration: 1.0 // 表示時間（秒）
            });
        }

        // スコアポップアップの更新
        function updateScorePopups(delta) {
            for (let i = scorePopups.length - 1; i >= 0; i--) {
                const popup = scorePopups[i];
                popup.age += delta;

                if (popup.age >= popup.duration) {
                    // 寿命が尽きたら削除
                    scene.remove(popup.sprite);
                    scorePopups.splice(i, 1);
                    continue;
                }

                // 進行度（0～1）
                const progress = popup.age / popup.duration;

                // 上に浮かび上がる
                popup.sprite.position.y += delta * 2;

                // 透明度の更新（徐々に消える）
                popup.sprite.material.opacity = 1 - progress;

                // サイズの更新（最初は大きく、徐々に通常サイズに）
                const scale = 2 - progress * 0.5;
                popup.sprite.scale.set(scale * 2, scale, 1);
            }
        }

        // 難易度レベルのチェックと更新
        function checkDifficultyLevel() {
            // 前回のレベルアップからのスコア増加をチェック
            if (score - difficulty.lastLevelUpScore >= difficulty.scoreThreshold && difficulty.level < difficulty.maxLevel) {
                // 難易度レベルアップ
                difficulty.level++;
                difficulty.lastLevelUpScore = score;

                // 敵の速度と射撃頻度を増加
                difficulty.enemySpeed += 0.02;
                difficulty.enemyFireRate += 0.005;

                // 敵の速度を更新
                enemies.forEach(enemy => {
                    enemy.speed = difficulty.enemySpeed;
                });

                // レベルアップ通知
                createLevelUpNotification();
            }
        }

        // レベルアップ通知
        function createLevelUpNotification() {
            // 画面中央に大きなテキスト表示
            const levelUpDiv = document.createElement('div');
            levelUpDiv.style.position = 'fixed';
            levelUpDiv.style.top = '50%';
            levelUpDiv.style.left = '50%';
            levelUpDiv.style.transform = 'translate(-50%, -50%)';
            levelUpDiv.style.color = '#ffff00';
            levelUpDiv.style.fontSize = '48px';
            levelUpDiv.style.fontWeight = 'bold';
            levelUpDiv.style.textShadow = '0 0 10px #ff0000, 0 0 20px #ff0000';
            levelUpDiv.style.zIndex = '1000';
            levelUpDiv.style.pointerEvents = 'none';
            levelUpDiv.style.opacity = '1';
            levelUpDiv.style.transition = 'opacity 2s';
            levelUpDiv.textContent = `レベル ${difficulty.level}！ 難易度アップ！`;

            document.body.appendChild(levelUpDiv);

            // 効果音
            playSound('powerup');

            // 画面シェイク
            shakeCamera(0.3, 0.5);

            // 2秒後にフェードアウト
            setTimeout(() => {
                levelUpDiv.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(levelUpDiv);
                }, 2000);
            }, 2000);
        }

        // アニメーションループ
        function animate() {
            requestAnimationFrame(animate);

            if (!isGameActive) return;

            const delta = clock.getDelta();
            const time = clock.getElapsedTime();

            // プレイヤーのアニメーション更新
            if (player && player.mixer) {
                player.mixer.update(delta);
            }

            // プレイヤーの移動
            if (player) {
                if (moveForward) player.position.z -= playerSpeed;
                if (moveBackward) player.position.z += playerSpeed;
                if (moveLeft) player.position.x -= playerSpeed;
                if (moveRight) player.position.x += playerSpeed;

                // 移動範囲の制限
                player.position.x = Math.max(-20, Math.min(20, player.position.x));
                player.position.z = Math.max(-20, Math.min(20, player.position.z));

                // カメラをプレイヤーに追従（より近く）
                camera.position.x = player.position.x;
                camera.position.y = player.position.y + 2;
                camera.position.z = player.position.z +2; // より近くに配置
                camera.lookAt(player.position.x, player.position.y, player.position.z - 5);
            }

            // 射撃クールダウン
            if (!canShoot && time - lastShootTime > shootCooldown) {
                canShoot = true;
            }

            // 敵のランダム射撃
            if (enemies.length > 0) {
                // ボスの攻撃パターン
                const boss = enemies.find(enemy => enemy.isBoss);
                if (boss) {
                    const currentTime = clock.getElapsedTime();

                    // 攻撃クールダウンをチェック
                    if (currentTime - boss.lastAttackTime > boss.attackCooldown) {
                        boss.lastAttackTime = currentTime;

                        // 攻撃パターンに基づいて攻撃
                        switch(boss.attackPattern) {
                            case 0: // 通常攻撃（単発）
                                createBullet(false, boss);
                                break;

                            case 1: // 拡散攻撃（3発）
                                createBullet(false, boss, -1, 0, -0.2);
                                createBullet(false, boss);
                                createBullet(false, boss, 1, 0, 0.2);
                                break;

                            case 2: // 円形攻撃（8発）
                                for (let i = 0; i < 8; i++) {
                                    const angle = (i / 8) * Math.PI * 2;
                                    const vx = Math.sin(angle) * 0.5;
                                    const vz = Math.cos(angle) * 0.5;
                                    createBullet(false, boss, Math.sin(angle) * 2, 0, vx, vz);
                                }
                                break;

                            case 3: // 超拡散攻撃（6発に削減）+ レーザー
                                // 円形攻撃の弾数を減らして6発に
                                for (let i = 0; i < 6; i++) {
                                    const angle = (i / 6) * Math.PI * 2;
                                    const vx = Math.sin(angle) * 0.5;
                                    const vz = Math.cos(angle) * 0.5;
                                    createBullet(false, boss, Math.sin(angle) * 2, 0, vx, vz);
                                }

                                // レーザー攻撃（プレイヤーを狙う）
                                const directionToPlayer = new THREE.Vector3()
                                    .subVectors(player.position, boss.position)
                                    .normalize();

                                // レーザービームは大きめに
                                const laserBullet = createBullet(false, boss, 0, 0, directionToPlayer.x, directionToPlayer.z);
                                laserBullet.scale.set(2.5, 2.5, 2.5); // レーザービームを大きく
                                break;
                        }
                    }
                } else if (Math.random() < difficulty.enemyFireRate) {
                    // 通常の敵のランダム射撃
                    createBullet(false);
                }
            }

            // 難易度の更新をチェック
            checkDifficultyLevel();

            // 敵の移動
            let needsDirectionChange = false;
            enemies.forEach(enemy => {
                // 横移動
                enemy.position.x += enemy.speed * enemy.direction;

                // 上下の揺れ
                enemy.position.y = 1 + Math.sin(time + enemy.phaseOffset) * enemy.amplitude;

                // 画面端に到達したら方向転換のフラグを立てる
                if (enemy.position.x > 20 || enemy.position.x < -20) {
                    needsDirectionChange = true;
                }

                // 回転アニメーション
                enemy.rotation.z += 0.01;
            });

            // 全ての敵の方向を反転し、前進させる
            if (needsDirectionChange) {
                enemies.forEach(enemy => {
                    enemy.direction *= -1;
                    enemy.position.z += 0.5; // 前進

                    // プレイヤーに近づきすぎたらゲームオーバー
                    if (enemy.position.z > player.position.z - 2) {
                        gameOver();
                    }
                });
            }

            // 弾の移動
            bullets.forEach((bullet, index) => {
                // 速度に基づいて位置を更新
                bullet.position.add(bullet.velocity);

                // 画面外に出たら削除
                if (bullet.position.z < -50 || bullet.position.z > 50) {
                    scene.remove(bullet);
                    bullets.splice(index, 1);
                }
            });

            // パワーアップのアニメーション
            powerUps.forEach(powerUp => {
                // 回転
                powerUp.rotation.x += powerUp.rotationSpeed.x;
                powerUp.rotation.y += powerUp.rotationSpeed.y;
                powerUp.rotation.z += powerUp.rotationSpeed.z;

                // 浮遊
                powerUp.position.y = 1 + Math.sin(time + powerUp.floatOffset) * powerUp.floatHeight;

                // 光の強度を変化させる
                if (powerUp.children.length > 0) {
                    const light = powerUp.children[0];
                    light.intensity = 1 + Math.sin(time * 2) * 0.3;
                }
            });

            // パワーアップの効果時間管理
            updatePowerupEffects(time);

            // パワーアップUIの更新
            updatePowerupUI();

            // 衝突判定
            checkCollisions();

            // パーティクルのアニメーション
            animateParticles();

            // 爆発エフェクトの更新
            updateExplosions(delta);

            // スコアポップアップの更新
            updateScorePopups(delta);

            // カメラシェイクの更新
            updateCameraShake();

            // レンダリング
            renderer.render(scene, camera);
        }

        // DOM読み込み完了後にイベントリスナーを設定
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM fully loaded');
            // スタートボタンのイベント
            document.getElementById('startButton').addEventListener('click', function() {
                console.log('Start button clicked');
                this.style.display = 'none';
                init();
            });
        });
    </script>
</body>
</html>
