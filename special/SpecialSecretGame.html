<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kumayu 3Dã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚° - å´‡åŸå¤§å­¦èŠ¸è¡“å­¦éƒ¨ç¾è¡“å­¦ç§‘ 3Dã‚¢ãƒ¼ãƒˆã‚³ãƒ¼ã‚¹</title>
    <!-- Three.js ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <!-- Three.js æ‹¡å¼µãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <!-- GLTFLoader for loading 3D models -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Noto Sans JP', sans-serif;
        }

        /* ã‚²ãƒ¼ãƒ UIè¦ç´  */
        .game-ui {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            font-size: 24px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            z-index: 100;
            pointer-events: none;
            display: none;
        }

        .game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 48px;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            z-index: 100;
            display: none;
        }

        .restart-button {
            margin-top: 20px;
            background-color: #4285f4;
            color: #fff;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 20px rgba(66, 133, 244, 0.5);
            transition: all 0.3s ease;
            pointer-events: auto;
        }

        .restart-button:hover {
            background-color: #3367d6;
            box-shadow: 0 0 30px rgba(66, 133, 244, 0.8);
            transform: scale(1.05);
        }

        body {
            background-color: #000;
            color: #fff;
            line-height: 1.6;
            overflow: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ« */
        header {
            background-color: rgba(0, 0, 0, 0.7);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
        }

        .logo {
            display: flex;
            align-items: center;
        }

        .logo-text {
            font-size: 18px;
            font-weight: 700;
            color: #fff;
        }

        .logo-text span {
            display: block;
            font-size: 14px;
            color: #aaa;
            font-weight: 400;
        }

        nav ul {
            display: flex;
            list-style: none;
        }

        nav ul li {
            margin-left: 30px;
        }

        nav ul li a {
            text-decoration: none;
            color: #fff;
            font-weight: 500;
            transition: color 0.3s;
            position: relative;
            padding-bottom: 5px;
        }

        nav ul li a:after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            background: #4285f4;
            bottom: 0;
            left: 0;
            transition: width 0.3s;
        }

        nav ul li a:hover {
            color: #4285f4;
        }

        nav ul li a:hover:after {
            width: 100%;
        }

        /* ã‚²ãƒ¼ãƒ ã‚­ãƒ£ãƒ³ãƒã‚¹ */
        #game-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* UI ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        .ui-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
        }

        .game-title {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #fff;
            font-size: 3rem;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(66, 133, 244, 0.8), 
                         0 0 20px rgba(66, 133, 244, 0.5), 
                         0 0 30px rgba(66, 133, 244, 0.3);
        }

        .game-subtitle {
            margin-top: 20px;
            font-size: 1.5rem;
        }

        .start-button {
            position: absolute;
            bottom: 150px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4285f4;
            color: #fff;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 20px rgba(66, 133, 244, 0.5);
            transition: all 0.3s ease;
            pointer-events: auto;
        }

        .start-button:hover {
            background-color: #3367d6;
            box-shadow: 0 0 30px rgba(66, 133, 244, 0.8);
            transform: translateX(-50%) scale(1.05);
        }

        /* ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
        @keyframes particle-glow {
            0% {
                box-shadow: 0 0 5px 2px rgba(66, 133, 244, 0.3);
            }
            50% {
                box-shadow: 0 0 10px 4px rgba(66, 133, 244, 0.6);
            }
            100% {
                box-shadow: 0 0 5px 2px rgba(66, 133, 244, 0.3);
            }
        }

        .particle {
            position: absolute;
            width: 5px;
            height: 5px;
            background-color: #4285f4;
            border-radius: 50%;
            animation: particle-glow 2s infinite;
            pointer-events: none;
        }

        /* é­”æ³•ã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes magicEffect {
            0% {
                background-position: 0% 50%;
                filter: blur(3px);
                background-image: linear-gradient(90deg,
                #ffb6c1, #ffd700, #98fb98, #add8e6, #d8bfd8);
            }
            50% {
                background-position: 100% 50%;
                filter: blur(2px);
                background-image: linear-gradient(90deg,
                #ffb6c1, #ffd700, #98fb98, #add8e6, #d8bfd8);
            }
            100% {
                background-position: 0% 50%;
                filter: blur(0px);
                background-image: linear-gradient(90deg,
                rgba(255, 255, 255, 0.95) 0%,
                rgba(255, 255, 255, 1) 100%
                );
            }
        }

        .magic-text-effect {
            position: relative;
            display: inline-block;
            background-image: linear-gradient(90deg, 
                #ffb6c1, #ffd700, #98fb98, #add8e6, #d8bfd8);
            background-size: 200% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-fill-color: transparent;
            animation: magicEffect 4s ease-in-out infinite;
        }

        /* ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—UI */
        .score-container {
            font-size: 28px;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
        }

        .powerup-container {
            display: flex;
            margin-top: 10px;
            gap: 10px;
        }

        .powerup-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            font-size: 24px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            animation: pulse 1.5s infinite;
        }

        .rapid-fire {
            background-color: rgba(255, 85, 0, 0.3);
            box-shadow: 0 0 10px rgba(255, 85, 0, 0.8);
        }

        .triple-shot {
            background-color: rgba(0, 255, 255, 0.3);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.8);
        }

        .shield {
            background-color: rgba(0, 255, 0, 0.3);
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.8);
        }

        /* ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ã‚¿ã‚¤ãƒãƒ¼ */
        .powerup-timers {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            width: 200px;
        }

        .timer-bar-container {
            width: 100%;
            height: 15px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .timer-bar {
            height: 100%;
            border-radius: 10px;
            transition: width 0.1s linear;
        }

        .timer-label {
            position: absolute;
            top: 0;
            left: 5px;
            font-size: 12px;
            line-height: 15px;
            color: white;
            text-shadow: 1px 1px 2px black;
        }

        .timer-rapid-fire .timer-bar {
            background: linear-gradient(to right, #ff5500, #ff8800);
        }

        .timer-triple-shot .timer-bar {
            background: linear-gradient(to right, #00ffff, #00aaff);
        }

        .timer-shield .timer-bar {
            background: linear-gradient(to right, #00ff00, #88ff00);
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header>
        <div class="container header-container">
            <div class="logo">
                <div class="logo-text">å´‡åŸå¤§å­¦ èŠ¸è¡“å­¦éƒ¨<span>3Dã‚¢ãƒ¼ãƒˆã‚³ãƒ¼ã‚¹</span></div>
            </div>
            <nav>
                <ul>
                    <li><a href="../index.html">ãƒ›ãƒ¼ãƒ </a></li>
                    <li><a href="../gallery.html">ã‚®ãƒ£ãƒ©ãƒªãƒ¼</a></li>
                    <li><a href="../news_event.html">ãƒ‹ãƒ¥ãƒ¼ã‚¹</a></li>
                    <li><a href="../question.html">ã‚ˆãã‚ã‚‹è³ªå•</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- ã‚²ãƒ¼ãƒ ã‚­ãƒ£ãƒ³ãƒã‚¹ -->
    <div id="game-container"></div>

    <!-- UI ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div class="ui-overlay">
        <div class="game-title" id="gameTitle">
            <span class="magic-text-effect">Kumayu 3Dã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°</span>
            <div class="game-subtitle">å´‡åŸå¤§å­¦èŠ¸è¡“å­¦éƒ¨ç¾è¡“å­¦ç§‘ 3Dã‚¢ãƒ¼ãƒˆã‚³ãƒ¼ã‚¹</div>
        </div>
        <button class="start-button" id="startButton">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        <div id="gameInstructions" style="position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); text-align: center; display: none;">
            <p>WASDã‚­ãƒ¼ã§ç§»å‹•ã€ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã§å°„æ’ƒ</p>
            <p>ã‚¤ãƒ³ãƒ™ãƒ¼ãƒ€ãƒ¼ã‚’å…¨ã¦å€’ãã†ï¼</p>
        </div>

        <!-- ã‚²ãƒ¼ãƒ UI -->
        <div class="game-ui" id="gameUI">
            <div class="score-container">ã‚¹ã‚³ã‚¢: <span id="scoreDisplay">0</span></div>
            <div id="powerupUI" class="powerup-container"></div>
            <div class="powerup-timers" id="powerupTimers"></div>
        </div>

        <!-- ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”»é¢ -->
        <div class="game-over" id="gameOver">
            <div>ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼</div>
            <div>æœ€çµ‚ã‚¹ã‚³ã‚¢: <span id="finalScore">0</span></div>
            <button class="restart-button" id="restartButton">ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤</button>
        </div>
    </div>

    <script>
        // Three.js å¤‰æ•°å®£è¨€
        let scene, camera, renderer, controls;
        let player, playerModel;
        let enemies = [], bullets = [], particles = [];
        let explosions = []; // çˆ†ç™ºã‚¨ãƒ•ã‚§ã‚¯ãƒˆç”¨é…åˆ—
        let scorePopups = []; // ã‚¹ã‚³ã‚¢ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ç”¨é…åˆ—
        let powerUps = []; // ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ã‚¢ã‚¤ãƒ†ãƒ ç”¨é…åˆ—
        let clock;
        let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false;
        let playerSpeed = 0.15;
        let canShoot = true;
        let shootCooldown = 0.5; // ç§’
        let lastShootTime = 0;
        let score = 0;
        let isGameOver = false;
        let isGameActive = false;
        let cameraShake = { active: false, intensity: 0, duration: 0, startTime: 0 }; // ã‚«ãƒ¡ãƒ©ã‚·ã‚§ã‚¤ã‚¯ç”¨

        // é›£æ˜“åº¦è¨­å®š
        let difficulty = {
            level: 1,
            maxLevel: 5,
            enemySpeed: 0.05,
            enemyFireRate: 0.01,
            scoreThreshold: 1000, // æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã«é€²ã‚€ã‚¹ã‚³ã‚¢é–¾å€¤
            lastLevelUpScore: 0
        };

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å¼·åŒ–çŠ¶æ…‹
        let playerPowerups = {
            rapidFire: { active: false, duration: 5, startTime: 0 }, // é€£å°„
            tripleShot: { active: false, duration: 10, startTime: 0 }, // 3é€£å°„
            shield: { active: false, duration: 15, startTime: 0 },     // ã‚·ãƒ¼ãƒ«ãƒ‰
            bomb: { active: false, duration: 0, startTime: 0 },       // çˆ†å¼¾ï¼ˆä¸€å›é™ã‚Šã®åŠ¹æœï¼‰
            speedBoost: { active: false, duration: 8, startTime: 0 }, // é€Ÿåº¦ã‚¢ãƒƒãƒ—
            health: { active: false, duration: 0, startTime: 0 }      // ä½“åŠ›å›å¾©ï¼ˆä¸€å›é™ã‚Šã®åŠ¹æœï¼‰
        };

        // ã‚µã‚¦ãƒ³ãƒ‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
        let sounds = {
            bgm: null,
            shoot: null,
            explosion: null,
            powerup: null,
            gameOver: null,
            gameWin: null
        };

        // ã‚µã‚¦ãƒ³ãƒ‰åˆæœŸåŒ–
        function initSounds() {
            // BGM
            sounds.bgm = new Audio('https://assets.codepen.io/21542/TownTheme.mp3');
            sounds.bgm.loop = true;
            sounds.bgm.volume = 0.3;

            // å°„æ’ƒéŸ³
            sounds.shoot = new Audio('https://assets.codepen.io/21542/shoot.mp3');
            sounds.shoot.volume = 0.2;

            // çˆ†ç™ºéŸ³
            sounds.explosion = new Audio('https://assets.codepen.io/21542/explosion.mp3');
            sounds.explosion.volume = 0.3;

            // ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—å–å¾—éŸ³
            sounds.powerup = new Audio('https://assets.codepen.io/21542/powerup.mp3');
            sounds.powerup.volume = 0.4;

            // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼éŸ³
            sounds.gameOver = new Audio('https://assets.codepen.io/21542/gameover.mp3');
            sounds.gameOver.volume = 0.5;

            // ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢éŸ³
            sounds.gameWin = new Audio('https://assets.codepen.io/21542/win.mp3');
            sounds.gameWin.volume = 0.5;
        }

        // ã‚µã‚¦ãƒ³ãƒ‰å†ç”Ÿ
        function playSound(soundName) {
            if (sounds[soundName]) {
                // å†ç”Ÿä¸­ãªã‚‰å·»ãæˆ»ã—ã¦å†ç”Ÿ
                sounds[soundName].currentTime = 0;
                sounds[soundName].play().catch(e => console.log("Sound play error:", e));
            }
        }

        // ã‚²ãƒ¼ãƒ åˆæœŸåŒ–
        function init() {
            console.log('Game initialization started');
            isGameActive = true;
            score = 0;
            isGameOver = false;

            // ã‚µã‚¦ãƒ³ãƒ‰åˆæœŸåŒ–
            initSounds();

            // BGMå†ç”Ÿ
            playSound('bgm');

            // UIè¡¨ç¤º
            document.getElementById('gameTitle').style.display = 'none';
            document.getElementById('gameInstructions').style.display = 'block';
            document.getElementById('gameUI').style.display = 'block';
            document.getElementById('scoreDisplay').textContent = '0';
            document.getElementById('gameOver').style.display = 'none';

            // ã‚¯ãƒ­ãƒƒã‚¯åˆæœŸåŒ–
            clock = new THREE.Clock();

            // ã‚·ãƒ¼ãƒ³ä½œæˆ
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000000);
            scene.fog = new THREE.FogExp2(0x000000, 0.01);

            // ã‚«ãƒ¡ãƒ©è¨­å®š
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 5, 10);

            // ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼è¨­å®š
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            document.getElementById('game-container').appendChild(renderer.domElement);

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è¨­å®š - OrbitControlsã¯ä½¿ã‚ãªã„
            // ä»£ã‚ã‚Šã«ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œã§ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å‹•ã‹ã™

            // ãƒ©ã‚¤ãƒˆè¨­å®š
            const ambientLight = new THREE.AmbientLight(0x404040, 1);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(5, 10, 7.5);
            directionalLight.castShadow = true;
            scene.add(directionalLight);

            // ç‚¹æ»…ã™ã‚‹ãƒã‚¤ãƒ³ãƒˆãƒ©ã‚¤ãƒˆ
            const pointLight1 = new THREE.PointLight(0x4285f4, 1, 50);
            pointLight1.position.set(0, 15, 0);
            scene.add(pointLight1);

            const pointLight2 = new THREE.PointLight(0xff0000, 1, 30);
            pointLight2.position.set(-10, 5, 10);
            scene.add(pointLight2);

            const pointLight3 = new THREE.PointLight(0x00ff00, 1, 30);
            pointLight3.position.set(10, 5, 10);
            scene.add(pointLight3);

            // ãƒ©ã‚¤ãƒˆã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            function animateLights() {
                const time = Date.now() * 0.001;

                pointLight1.intensity = 1 + Math.sin(time) * 0.5;
                pointLight2.intensity = 1 + Math.sin(time * 1.1) * 0.5;
                pointLight3.intensity = 1 + Math.sin(time * 0.9) * 0.5;

                requestAnimationFrame(animateLights);
            }
            animateLights();

            // ã‚²ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ä½œæˆ
            const fieldSize = 50;
            const groundGeometry = new THREE.PlaneGeometry(fieldSize, fieldSize);
            const groundMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x222222,
                metalness: 0.8,
                roughness: 0.2
            });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);

            // ã‚°ãƒªãƒƒãƒ‰
            const gridHelper = new THREE.GridHelper(fieldSize, fieldSize, 0x444444, 0x222222);
            scene.add(gridHelper);

            // èƒŒæ™¯ã®æ˜Ÿç©º
            createStars();

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ï¼ˆKumayuï¼‰ã®èª­ã¿è¾¼ã¿
            const loader = new THREE.GLTFLoader();

            // è¤‡æ•°ã®ãƒ‘ã‚¹ã‚’è©¦ã™é–¢æ•°
            function tryLoadModel(paths, index) {
                if (index >= paths.length) {
                    console.error('ã™ã¹ã¦ã®ãƒ‘ã‚¹ã§ãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    return;
                }

                console.log('ãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­: ' + paths[index]);

                loader.load(paths[index], function(gltf) {
                    console.log('ãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿ã«æˆåŠŸã—ã¾ã—ãŸ: ' + paths[index]);
                    playerModel = gltf.scene;
                    playerModel.scale.set(1.0, 1.0, 1.0);
                    playerModel.rotation.y = Math.PI/2; // 90åº¦å›è»¢
                    playerModel.position.set(0, 0, 0);
                    playerModel.castShadow = true;
                    playerModel.receiveShadow = true;

                    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ
                    player = new THREE.Object3D();
                    player.add(playerModel);
                    player.position.set(0, 0, 10);
                    scene.add(player);

                    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒŸã‚­ã‚µãƒ¼ã®è¨­å®šï¼ˆãƒªã‚°ãŒå…¥ã£ã¦ã„ã‚‹å ´åˆï¼‰
                    if (gltf.animations && gltf.animations.length > 0) {
                        const mixer = new THREE.AnimationMixer(playerModel);
                        const idleAction = mixer.clipAction(gltf.animations[0]);
                        idleAction.play();

                        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–°é–¢æ•°ã‚’ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ—ã«è¿½åŠ 
                        player.mixer = mixer;
                    }

                    // æ•µã®ä½œæˆ
                    createEnemies();

                    // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚·ã‚¹ãƒ†ãƒ 
                    createParticleSystem();

                    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
                    setupEventListeners();

                    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ—é–‹å§‹
                    animate();
                }, undefined, function(error) {
                    console.error('ãƒ‘ã‚¹ ' + paths[index] + ' ã§ã®ãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                    // æ¬¡ã®ãƒ‘ã‚¹ã‚’è©¦ã™
                    tryLoadModel(paths, index + 1);
                });
            }

            // è©¦ã™ãƒ‘ã‚¹ã®é…åˆ—
            const modelPaths = [
                './Models/Kumayu.glb',
                '../special/Models/Kumayu.glb',
                'special/Models/Kumayu.glb',
                'Models/Kumayu.glb'
            ];

            // æœ€åˆã®ãƒ‘ã‚¹ã‹ã‚‰è©¦ã™
            tryLoadModel(modelPaths, 0);

            // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
            window.addEventListener('resize', onWindowResize);
        }

        // æ˜Ÿç©ºã®ä½œæˆ
        function createStars() {
            const starsGeometry = new THREE.BufferGeometry();
            const starsMaterial = new THREE.PointsMaterial({
                color: 0xffffff,
                size: 0.1,
                transparent: true
            });

            const starsVertices = [];
            for (let i = 0; i < 10000; i++) {
                const x = (Math.random() - 0.5) * 2000;
                const y = (Math.random() - 0.5) * 2000;
                const z = (Math.random() - 0.5) * 2000;
                starsVertices.push(x, y, z);
            }

            starsGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starsVertices, 3));
            const stars = new THREE.Points(starsGeometry, starsMaterial);
            scene.add(stars);
        }

        // æ•µã®ä½œæˆ
        function createEnemies() {
            // æ•µã®é…ç½®ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆ5è¡Œx8åˆ—ï¼‰
            const rows = 5;
            const cols = 8;
            const spacing = 3;

            for (let row = 0; row < rows; row++) {
                for (let col = 0; col < cols; col++) {
                    // æ•µã®ã‚¸ã‚ªãƒ¡ãƒˆãƒªã¨ãƒãƒ†ãƒªã‚¢ãƒ«
                    const geometry = new THREE.ConeGeometry(0.5, 1, 8);
                    const material = new THREE.MeshStandardMaterial({
                        color: 0xff0000,
                        emissive: 0x330000,
                        metalness: 0.8,
                        roughness: 0.2
                    });
                    const enemy = new THREE.Mesh(geometry, material);

                    // ä½ç½®ã®è¨­å®š
                    enemy.position.x = (col - (cols - 1) / 2) * spacing;
                    enemy.position.y = 1;
                    enemy.position.z = -10 - row * spacing;
                    enemy.rotation.x = Math.PI; // å…ˆç«¯ã‚’ä¸‹å‘ãã«

                    enemy.castShadow = true;
                    enemy.receiveShadow = true;

                    // æ•µã®ç§»å‹•ãƒ‘ã‚¿ãƒ¼ãƒ³
                    enemy.direction = 1; // 1: å³, -1: å·¦
                    enemy.speed = difficulty.enemySpeed;
                    enemy.amplitude = 0.5; // ä¸Šä¸‹ã®æºã‚Œå¹…
                    enemy.phaseOffset = Math.random() * Math.PI * 2; // ä½ç›¸ã®ãšã‚Œ

                    // æ•µã®å…‰
                    const enemyLight = new THREE.PointLight(0xff0000, 0.5, 2);
                    enemyLight.position.set(0, 0, 0);
                    enemy.add(enemyLight);

                    scene.add(enemy);
                    enemies.push(enemy);
                }
            }

            // åˆæœŸãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«é…ç½®
            setTimeout(spawnPowerUp, 5000); // 5ç§’å¾Œã«æœ€åˆã®ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ã‚’å‡ºç¾
        }

        // ãƒœã‚¹ã®ä½œæˆ
        function spawnBoss() {
            if (!isGameActive || isGameOver) return;

            // ãƒœã‚¹å‡ºç¾ã®é€šçŸ¥
            const bossWarning = document.createElement('div');
            bossWarning.style.position = 'fixed';
            bossWarning.style.top = '50%';
            bossWarning.style.left = '50%';
            bossWarning.style.transform = 'translate(-50%, -50%)';
            bossWarning.style.color = '#ff0000';
            bossWarning.style.fontSize = '48px';
            bossWarning.style.fontWeight = 'bold';
            bossWarning.style.textShadow = '0 0 10px #ff0000, 0 0 20px #ff0000';
            bossWarning.style.zIndex = '1000';
            bossWarning.style.pointerEvents = 'none';
            bossWarning.style.opacity = '1';
            bossWarning.style.transition = 'opacity 2s';
            bossWarning.textContent = 'ãƒœã‚¹å‡ºç¾ï¼ï¼';

            document.body.appendChild(bossWarning);

            // åŠ¹æœéŸ³
            playSound('explosion');

            // ç”»é¢ã‚·ã‚§ã‚¤ã‚¯
            shakeCamera(1.0, 1.0);

            // 2ç§’å¾Œã«ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
            setTimeout(() => {
                bossWarning.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(bossWarning);
                }, 2000);
            }, 2000);

            // ãƒœã‚¹ã®ã‚¸ã‚ªãƒ¡ãƒˆãƒªã¨ãƒãƒ†ãƒªã‚¢ãƒ«
            const geometry = new THREE.SphereGeometry(3, 32, 32);
            const material = new THREE.MeshStandardMaterial({
                color: 0xff0000,
                emissive: 0x550000,
                metalness: 0.9,
                roughness: 0.1
            });
            const boss = new THREE.Mesh(geometry, material);

            // ä½ç½®ã®è¨­å®š
            boss.position.x = 0;
            boss.position.y = 3;
            boss.position.z = -30;

            boss.castShadow = true;
            boss.receiveShadow = true;

            // ãƒœã‚¹ã®ç‰¹æ€§
            boss.isBoss = true;
            boss.health = 20; // 20å›ãƒ’ãƒƒãƒˆã§å€’ã›ã‚‹
            boss.maxHealth = 20;
            boss.attackCooldown = 1.0; // æ”»æ’ƒé–“éš”ï¼ˆç§’ï¼‰
            boss.lastAttackTime = 0;
            boss.attackPattern = 0; // æ”»æ’ƒãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆ0: é€šå¸¸, 1: æ‹¡æ•£, 2: ãƒ¬ãƒ¼ã‚¶ãƒ¼ï¼‰
            boss.phaseThresholds = [0.7, 0.4, 0.1]; // å„ãƒ•ã‚§ãƒ¼ã‚ºã®é–¾å€¤ï¼ˆæ®‹ã‚Šä½“åŠ›ã®å‰²åˆï¼‰
            boss.currentPhase = 0;

            // ãƒœã‚¹ã®ç§»å‹•ãƒ‘ã‚¿ãƒ¼ãƒ³
            boss.direction = 1; // 1: å³, -1: å·¦
            boss.speed = 0.1;
            boss.amplitude = 0.5; // ä¸Šä¸‹ã®æºã‚Œå¹…
            boss.phaseOffset = Math.random() * Math.PI * 2; // ä½ç›¸ã®ãšã‚Œ

            // ãƒœã‚¹ã®å…‰
            const bossLight = new THREE.PointLight(0xff0000, 2, 10);
            bossLight.position.set(0, 0, 0);
            boss.add(bossLight);

            // ãƒœã‚¹ã®è£…é£¾ï¼ˆè§¦æ‰‹ï¼‰
            const tentacleCount = 8;
            for (let i = 0; i < tentacleCount; i++) {
                const angle = (i / tentacleCount) * Math.PI * 2;
                const tentacleGeometry = new THREE.CylinderGeometry(0.3, 0.1, 2, 8);
                const tentacleMaterial = new THREE.MeshStandardMaterial({
                    color: 0xff0000,
                    emissive: 0x330000,
                    metalness: 0.8,
                    roughness: 0.2
                });
                const tentacle = new THREE.Mesh(tentacleGeometry, tentacleMaterial);

                // è§¦æ‰‹ã®ä½ç½®ã¨å›è»¢
                tentacle.position.x = Math.sin(angle) * 3;
                tentacle.position.z = Math.cos(angle) * 3;
                tentacle.rotation.x = Math.PI / 2;
                tentacle.rotation.z = angle;

                boss.add(tentacle);

                // è§¦æ‰‹ã®å…ˆç«¯ã«å…‰
                const tentacleLight = new THREE.PointLight(0xff0000, 0.5, 2);
                tentacleLight.position.set(0, -1, 0);
                tentacle.add(tentacleLight);
            }

            scene.add(boss);
            enemies.push(boss);

            // ãƒœã‚¹ã®ãƒ˜ãƒ«ã‚¹ãƒãƒ¼UIã‚’ä½œæˆ
            createBossHealthBar();
        }

        // ãƒœã‚¹ã®ãƒ˜ãƒ«ã‚¹ãƒãƒ¼UIã‚’ä½œæˆ
        function createBossHealthBar() {
            const bossHealthBarContainer = document.createElement('div');
            bossHealthBarContainer.id = 'bossHealthBarContainer';
            bossHealthBarContainer.style.position = 'fixed';
            bossHealthBarContainer.style.bottom = '20px';
            bossHealthBarContainer.style.left = '50%';
            bossHealthBarContainer.style.transform = 'translateX(-50%)';
            bossHealthBarContainer.style.width = '80%';
            bossHealthBarContainer.style.height = '20px';
            bossHealthBarContainer.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            bossHealthBarContainer.style.borderRadius = '10px';
            bossHealthBarContainer.style.overflow = 'hidden';
            bossHealthBarContainer.style.zIndex = '100';

            const bossHealthBar = document.createElement('div');
            bossHealthBar.id = 'bossHealthBar';
            bossHealthBar.style.width = '100%';
            bossHealthBar.style.height = '100%';
            bossHealthBar.style.backgroundColor = '#ff0000';
            bossHealthBar.style.background = 'linear-gradient(to right, #ff0000, #ff5500)';
            bossHealthBar.style.transition = 'width 0.3s';

            const bossHealthLabel = document.createElement('div');
            bossHealthLabel.style.position = 'absolute';
            bossHealthLabel.style.top = '0';
            bossHealthLabel.style.left = '10px';
            bossHealthLabel.style.color = 'white';
            bossHealthLabel.style.fontSize = '14px';
            bossHealthLabel.style.lineHeight = '20px';
            bossHealthLabel.style.fontWeight = 'bold';
            bossHealthLabel.style.textShadow = '1px 1px 2px black';
            bossHealthLabel.textContent = 'ãƒœã‚¹';

            bossHealthBarContainer.appendChild(bossHealthBar);
            bossHealthBarContainer.appendChild(bossHealthLabel);
            document.body.appendChild(bossHealthBarContainer);
        }

        // ãƒœã‚¹ã®ãƒ˜ãƒ«ã‚¹ãƒãƒ¼ã‚’æ›´æ–°
        function updateBossHealthBar() {
            const boss = enemies.find(enemy => enemy.isBoss);
            if (!boss) return;

            const healthPercentage = (boss.health / boss.maxHealth) * 100;
            const bossHealthBar = document.getElementById('bossHealthBar');
            if (bossHealthBar) {
                bossHealthBar.style.width = `${healthPercentage}%`;
            }
        }

        // ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ã®ä½œæˆ
        function spawnPowerUp() {
            if (!isGameActive || isGameOver) return;

            // ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ã®ç¨®é¡ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠ
            const types = ['rapidFire', 'tripleShot', 'shield', 'bomb', 'speedBoost', 'health'];
            const type = types[Math.floor(Math.random() * types.length)];

            // ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ã®ã‚¸ã‚ªãƒ¡ãƒˆãƒªã¨ãƒãƒ†ãƒªã‚¢ãƒ«
            const geometry = new THREE.OctahedronGeometry(0.5, 0);

            let color, emissive;
            switch(type) {
                case 'rapidFire':
                    color = 0xff5500;    // ã‚ªãƒ¬ãƒ³ã‚¸
                    emissive = 0x551100;
                    break;
                case 'tripleShot':
                    color = 0x00ffff;    // ã‚·ã‚¢ãƒ³
                    emissive = 0x005555;
                    break;
                case 'shield':
                    color = 0x00ff00;    // ç·‘
                    emissive = 0x005500;
                    break;
                case 'bomb':
                    color = 0xff0000;    // èµ¤
                    emissive = 0x550000;
                    break;
                case 'speedBoost':
                    color = 0xffff00;    // é»„è‰²
                    emissive = 0x555500;
                    break;
                case 'health':
                    color = 0xff00ff;    // ãƒ”ãƒ³ã‚¯
                    emissive = 0x550055;
                    break;
            }

            const material = new THREE.MeshStandardMaterial({
                color: color,
                emissive: emissive,
                metalness: 1.0,
                roughness: 0.2,
                transparent: true,
                opacity: 0.9
            });

            const powerUp = new THREE.Mesh(geometry, material);

            // ãƒ©ãƒ³ãƒ€ãƒ ãªä½ç½®ï¼ˆãƒ—ãƒ¬ã‚¤ã‚¨ãƒªã‚¢å†…ï¼‰
            powerUp.position.x = (Math.random() - 0.5) * 30;
            powerUp.position.y = 1;
            powerUp.position.z = (Math.random() - 0.5) * 30;

            // å›è»¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£
            powerUp.rotationSpeed = {
                x: Math.random() * 0.05,
                y: Math.random() * 0.05,
                z: Math.random() * 0.05
            };

            // æµ®éŠã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£
            powerUp.floatSpeed = 0.01 + Math.random() * 0.01;
            powerUp.floatHeight = 0.5;
            powerUp.floatOffset = Math.random() * Math.PI * 2;

            // ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ã®ç¨®é¡ã‚’ä¿å­˜
            powerUp.powerUpType = type;

            // å…‰æºã‚’è¿½åŠ 
            const light = new THREE.PointLight(color, 1, 5);
            light.position.set(0, 0, 0);
            powerUp.add(light);

            scene.add(powerUp);
            powerUps.push(powerUp);

            // æ¬¡ã®ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆ10ã€œ20ç§’å¾Œï¼‰
            const nextSpawnTime = 10000 + Math.random() * 10000;
            setTimeout(spawnPowerUp, nextSpawnTime);
        }

        // å¼¾ã®ä½œæˆï¼ˆæœ€é©åŒ–ç‰ˆï¼‰
        // å…±æœ‰ã‚¸ã‚ªãƒ¡ãƒˆãƒªã‚’ä½¿ç”¨
        const bulletGeometry = new THREE.SphereGeometry(0.2, 6, 6);

        function createBullet(isPlayerBullet, sourceEnemy = null, offsetX = 0, offsetZ = 0, velocityX = 0, velocityZ = 1) {
            const material = new THREE.MeshStandardMaterial({
                color: isPlayerBullet ? 0x00ffff : 0xff0000,
                emissive: isPlayerBullet ? 0x00aaaa : 0xaa0000,
                metalness: 1,
                roughness: 0
            });
            const bullet = new THREE.Mesh(bulletGeometry, material);

            if (isPlayerBullet) {
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å¼¾
                bullet.position.copy(player.position);
                bullet.position.y += 0.5;
                bullet.position.x += offsetX;
                bullet.position.z += offsetZ;
                bullet.velocity = new THREE.Vector3(velocityX, 0, -1);
                bullet.isPlayerBullet = true;
            } else {
                // æ•µã®å¼¾
                let enemy;
                if (sourceEnemy) {
                    // æŒ‡å®šã•ã‚ŒãŸæ•µã‹ã‚‰ç™ºå°„
                    enemy = sourceEnemy;
                } else {
                    // ãƒ©ãƒ³ãƒ€ãƒ ãªæ•µã‹ã‚‰ç™ºå°„
                    enemy = enemies[Math.floor(Math.random() * enemies.length)];
                }

                bullet.position.copy(enemy.position);
                bullet.position.x += offsetX;
                bullet.position.z += offsetZ;

                // ãƒœã‚¹ã®å¼¾ã¯å¤§ããã™ã‚‹
                if (enemy.isBoss) {
                    bullet.scale.set(1.5, 1.5, 1.5);

                    // ãƒœã‚¹ã®ãƒ•ã‚§ãƒ¼ã‚ºã«å¿œã˜ã¦å¼¾ã®è‰²ã‚’å¤‰ãˆã‚‹
                    switch(enemy.attackPattern) {
                        case 1:
                            material.color.set(0xff6600);
                            material.emissive.set(0x551100);
                            break;
                        case 2:
                            material.color.set(0xffff00);
                            material.emissive.set(0x555500);
                            break;
                        case 3:
                            material.color.set(0xffffff);
                            material.emissive.set(0x555555);
                            break;
                    }
                }

                bullet.velocity = new THREE.Vector3(velocityX, 0, velocityZ);
                bullet.isPlayerBullet = false;
            }

            // å¼¾ã®å…‰ - ãƒœã‚¹ã®å¼¾ã¨ç‰¹å®šã®æ¡ä»¶ã§ã®ã¿å…‰ã‚’è¿½åŠ ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šï¼‰
            if (sourceEnemy && sourceEnemy.isBoss) {
                const bulletLight = new THREE.PointLight(material.color, 1, 3);
                bulletLight.position.set(0, 0, 0);
                bullet.add(bulletLight);
            } else if (isPlayerBullet) {
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å¼¾ã«ã‚‚å…‰ã‚’è¿½åŠ ï¼ˆã‚²ãƒ¼ãƒ æ€§ã‚’ç¶­æŒï¼‰
                const bulletLight = new THREE.PointLight(material.color, 0.7, 2);
                bulletLight.position.set(0, 0, 0);
                bullet.add(bulletLight);
            }

            scene.add(bullet);
            bullets.push(bullet);

            return bullet;
        }

        // å°„æ’ƒå‡¦ç†
        function shoot() {
            if (!canShoot || !isGameActive || isGameOver) return;

            if (playerPowerups.tripleShot.active) {
                // 3é€£å°„ãƒ¢ãƒ¼ãƒ‰
                createBullet(true, -0.5, 0, -0.1);  // å·¦
                createBullet(true);                 // ä¸­å¤®
                createBullet(true, 0.5, 0, 0.1);    // å³
            } else {
                // é€šå¸¸å°„æ’ƒ
                createBullet(true);
            }

            // å°„æ’ƒéŸ³
            playSound('shoot');

            canShoot = false;
            lastShootTime = clock.getElapsedTime();

            // å°„æ’ƒã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
            const muzzleFlash = new THREE.PointLight(0x00ffff, 2, 5);
            muzzleFlash.position.copy(player.position);
            muzzleFlash.position.z -= 1;
            scene.add(muzzleFlash);

            // 0.1ç§’å¾Œã«æ¶ˆãˆã‚‹
            setTimeout(() => {
                scene.remove(muzzleFlash);
            }, 100);
        }

        // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã®ä½œæˆ
        function createParticleSystem() {
            for (let i = 0; i < 100; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                document.body.appendChild(particle);

                // ãƒ©ãƒ³ãƒ€ãƒ ãªä½ç½®ã¨é€Ÿåº¦
                const position = {
                    x: Math.random() * window.innerWidth,
                    y: Math.random() * window.innerHeight
                };

                const velocity = {
                    x: (Math.random() - 0.5) * 2,
                    y: (Math.random() - 0.5) * 2
                };

                particle.style.left = position.x + 'px';
                particle.style.top = position.y + 'px';

                particles.push({
                    element: particle,
                    position: position,
                    velocity: velocity,
                    size: Math.random() * 5 + 2
                });
            }
        }

        // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        function animateParticles() {
            particles.forEach(particle => {
                // ä½ç½®ã®æ›´æ–°
                particle.position.x += particle.velocity.x;
                particle.position.y += particle.velocity.y;

                // ç”»é¢å¤–ã«å‡ºãŸã‚‰åå¯¾å´ã‹ã‚‰å†ç™»å ´
                if (particle.position.x < 0) particle.position.x = window.innerWidth;
                if (particle.position.x > window.innerWidth) particle.position.x = 0;
                if (particle.position.y < 0) particle.position.y = window.innerHeight;
                if (particle.position.y > window.innerHeight) particle.position.y = 0;

                // DOMã®æ›´æ–°
                particle.element.style.left = particle.position.x + 'px';
                particle.element.style.top = particle.position.y + 'px';
                particle.element.style.width = particle.size + 'px';
                particle.element.style.height = particle.size + 'px';
            });
        }

        // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
        function setupEventListeners() {
            // ã‚­ãƒ¼ãƒ€ã‚¦ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
            document.addEventListener('keydown', function(event) {
                switch(event.code) {
                    case 'KeyW':
                        moveForward = true;
                        break;
                    case 'KeyS':
                        moveBackward = true;
                        break;
                    case 'KeyA':
                        moveLeft = true;
                        break;
                    case 'KeyD':
                        moveRight = true;
                        break;
                    case 'Space':
                        // ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã§å°„æ’ƒ
                        shoot();
                        break;
                }
            });

            // ã‚­ãƒ¼ã‚¢ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆ
            document.addEventListener('keyup', function(event) {
                switch(event.code) {
                    case 'KeyW':
                        moveForward = false;
                        break;
                    case 'KeyS':
                        moveBackward = false;
                        break;
                    case 'KeyA':
                        moveLeft = false;
                        break;
                    case 'KeyD':
                        moveRight = false;
                        break;
                }
            });

            // ãƒªã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
            document.getElementById('restartButton').addEventListener('click', function() {
                // ã‚²ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦å†é–‹
                resetGame();
            });
        }

        // ã‚²ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
        function resetGame() {
            // æ—¢å­˜ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚¯ãƒªã‚¢
            while(scene.children.length > 0) { 
                scene.remove(scene.children[0]); 
            }

            enemies = [];
            bullets = [];

            // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚’å‰Šé™¤
            particles.forEach(particle => {
                document.body.removeChild(particle.element);
            });
            particles = [];

            // ã‚²ãƒ¼ãƒ ã‚’å†åˆæœŸåŒ–
            init();
        }

        // ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—åŠ¹æœã®æ›´æ–°
        function updatePowerupEffects(currentTime) {
            // é€£å°„ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—
            if (playerPowerups.rapidFire.active) {
                if (currentTime - playerPowerups.rapidFire.startTime > playerPowerups.rapidFire.duration) {
                    playerPowerups.rapidFire.active = false;
                    shootCooldown = 0.5; // é€šå¸¸ã®å°„æ’ƒé€Ÿåº¦ã«æˆ»ã™
                    updatePowerupUI();
                }
            }

            // 3é€£å°„ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—
            if (playerPowerups.tripleShot.active) {
                if (currentTime - playerPowerups.tripleShot.startTime > playerPowerups.tripleShot.duration) {
                    playerPowerups.tripleShot.active = false;
                    updatePowerupUI();
                }
            }

            // ã‚·ãƒ¼ãƒ«ãƒ‰ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—
            if (playerPowerups.shield.active) {
                if (currentTime - playerPowerups.shield.startTime > playerPowerups.shield.duration) {
                    playerPowerups.shield.active = false;
                    // ã‚·ãƒ¼ãƒ«ãƒ‰ã®è¦–è¦šåŠ¹æœã‚’å‰Šé™¤
                    if (player.shield) {
                        player.remove(player.shield);
                        player.shield = null;
                    }
                    updatePowerupUI();
                }
            }

            // ã‚¹ãƒ”ãƒ¼ãƒ‰ãƒ–ãƒ¼ã‚¹ãƒˆãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—
            if (playerPowerups.speedBoost.active) {
                if (currentTime - playerPowerups.speedBoost.startTime > playerPowerups.speedBoost.duration) {
                    playerPowerups.speedBoost.active = false;
                    playerSpeed = 0.15; // é€šå¸¸ã®ç§»å‹•é€Ÿåº¦ã«æˆ»ã™

                    // ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤
                    if (player.speedTrail) {
                        player.remove(player.speedTrail);
                        player.speedTrail = null;
                    }

                    updatePowerupUI();
                }
            }
        }

        // ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—UIã®æ›´æ–°
        function updatePowerupUI() {
            const time = clock.getElapsedTime();

            // ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ã‚¢ã‚¤ã‚³ãƒ³ã®æ›´æ–°
            const powerupUI = document.getElementById('powerupUI');
            if (!powerupUI) return;

            powerupUI.innerHTML = '';

            if (playerPowerups.rapidFire.active) {
                const rapidFireIcon = document.createElement('div');
                rapidFireIcon.className = 'powerup-icon rapid-fire';
                rapidFireIcon.innerHTML = 'ğŸ”¥';
                rapidFireIcon.title = 'é€£å°„ãƒ¢ãƒ¼ãƒ‰';
                powerupUI.appendChild(rapidFireIcon);
            }

            if (playerPowerups.tripleShot.active) {
                const tripleShotIcon = document.createElement('div');
                tripleShotIcon.className = 'powerup-icon triple-shot';
                tripleShotIcon.innerHTML = 'ğŸ”±';
                tripleShotIcon.title = '3é€£å°„ãƒ¢ãƒ¼ãƒ‰';
                powerupUI.appendChild(tripleShotIcon);
            }

            if (playerPowerups.shield.active) {
                const shieldIcon = document.createElement('div');
                shieldIcon.className = 'powerup-icon shield';
                shieldIcon.innerHTML = 'ğŸ›¡ï¸';
                shieldIcon.title = 'ã‚·ãƒ¼ãƒ«ãƒ‰';
                powerupUI.appendChild(shieldIcon);
            }

            if (playerPowerups.speedBoost.active) {
                const speedBoostIcon = document.createElement('div');
                speedBoostIcon.className = 'powerup-icon speed-boost';
                speedBoostIcon.style.backgroundColor = 'rgba(255, 255, 0, 0.3)';
                speedBoostIcon.style.boxShadow = '0 0 10px rgba(255, 255, 0, 0.8)';
                speedBoostIcon.innerHTML = 'âš¡';
                speedBoostIcon.title = 'ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚¢ãƒƒãƒ—';
                powerupUI.appendChild(speedBoostIcon);
            }

            // ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ã‚¿ã‚¤ãƒãƒ¼ã®æ›´æ–°
            const powerupTimers = document.getElementById('powerupTimers');
            if (!powerupTimers) return;

            powerupTimers.innerHTML = '';

            // é€£å°„ã‚¿ã‚¤ãƒãƒ¼
            if (playerPowerups.rapidFire.active) {
                const remainingTime = playerPowerups.rapidFire.duration - (time - playerPowerups.rapidFire.startTime);
                const percentage = (remainingTime / playerPowerups.rapidFire.duration) * 100;

                const timerContainer = document.createElement('div');
                timerContainer.className = 'timer-bar-container timer-rapid-fire';

                const timerBar = document.createElement('div');
                timerBar.className = 'timer-bar';
                timerBar.style.width = `${percentage}%`;

                const timerLabel = document.createElement('div');
                timerLabel.className = 'timer-label';
                timerLabel.textContent = 'é€£å°„ãƒ¢ãƒ¼ãƒ‰';

                timerContainer.appendChild(timerBar);
                timerContainer.appendChild(timerLabel);
                powerupTimers.appendChild(timerContainer);
            }

            // 3é€£å°„ã‚¿ã‚¤ãƒãƒ¼
            if (playerPowerups.tripleShot.active) {
                const remainingTime = playerPowerups.tripleShot.duration - (time - playerPowerups.tripleShot.startTime);
                const percentage = (remainingTime / playerPowerups.tripleShot.duration) * 100;

                const timerContainer = document.createElement('div');
                timerContainer.className = 'timer-bar-container timer-triple-shot';

                const timerBar = document.createElement('div');
                timerBar.className = 'timer-bar';
                timerBar.style.width = `${percentage}%`;

                const timerLabel = document.createElement('div');
                timerLabel.className = 'timer-label';
                timerLabel.textContent = '3é€£å°„ãƒ¢ãƒ¼ãƒ‰';

                timerContainer.appendChild(timerBar);
                timerContainer.appendChild(timerLabel);
                powerupTimers.appendChild(timerContainer);
            }

            // ã‚·ãƒ¼ãƒ«ãƒ‰ã‚¿ã‚¤ãƒãƒ¼
            if (playerPowerups.shield.active) {
                const remainingTime = playerPowerups.shield.duration - (time - playerPowerups.shield.startTime);
                const percentage = (remainingTime / playerPowerups.shield.duration) * 100;

                const timerContainer = document.createElement('div');
                timerContainer.className = 'timer-bar-container timer-shield';

                const timerBar = document.createElement('div');
                timerBar.className = 'timer-bar';
                timerBar.style.width = `${percentage}%`;

                const timerLabel = document.createElement('div');
                timerLabel.className = 'timer-label';
                timerLabel.textContent = 'ã‚·ãƒ¼ãƒ«ãƒ‰';

                timerContainer.appendChild(timerBar);
                timerContainer.appendChild(timerLabel);
                powerupTimers.appendChild(timerContainer);
            }

            // ã‚¹ãƒ”ãƒ¼ãƒ‰ãƒ–ãƒ¼ã‚¹ãƒˆã‚¿ã‚¤ãƒãƒ¼
            if (playerPowerups.speedBoost.active) {
                const remainingTime = playerPowerups.speedBoost.duration - (time - playerPowerups.speedBoost.startTime);
                const percentage = (remainingTime / playerPowerups.speedBoost.duration) * 100;

                const timerContainer = document.createElement('div');
                timerContainer.className = 'timer-bar-container timer-speed-boost';

                const timerBar = document.createElement('div');
                timerBar.className = 'timer-bar';
                timerBar.style.width = `${percentage}%`;
                timerBar.style.background = 'linear-gradient(to right, #ffff00, #ffaa00)';

                const timerLabel = document.createElement('div');
                timerLabel.className = 'timer-label';
                timerLabel.textContent = 'ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚¢ãƒƒãƒ—';

                timerContainer.appendChild(timerBar);
                timerContainer.appendChild(timerLabel);
                powerupTimers.appendChild(timerContainer);
            }
        }

        // ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ã®é©ç”¨
        function applyPowerup(type) {
            const time = clock.getElapsedTime();

            switch(type) {
                case 'rapidFire':
                    playerPowerups.rapidFire.active = true;
                    playerPowerups.rapidFire.startTime = time;
                    shootCooldown = 0.1; // å°„æ’ƒé€Ÿåº¦ã‚¢ãƒƒãƒ—
                    createScorePopup("é€£å°„ãƒ¢ãƒ¼ãƒ‰!", player.position);
                    break;

                case 'tripleShot':
                    playerPowerups.tripleShot.active = true;
                    playerPowerups.tripleShot.startTime = time;
                    createScorePopup("3é€£å°„ãƒ¢ãƒ¼ãƒ‰!", player.position);
                    break;

                case 'shield':
                    playerPowerups.shield.active = true;
                    playerPowerups.shield.startTime = time;

                    // ã‚·ãƒ¼ãƒ«ãƒ‰ã®è¦–è¦šåŠ¹æœ
                    if (!player.shield) {
                        const shieldGeometry = new THREE.SphereGeometry(1.2, 16, 16);
                        const shieldMaterial = new THREE.MeshBasicMaterial({
                            color: 0x00ff00,
                            transparent: true,
                            opacity: 0.3,
                            side: THREE.DoubleSide
                        });
                        player.shield = new THREE.Mesh(shieldGeometry, shieldMaterial);
                        player.add(player.shield);

                        // ã‚·ãƒ¼ãƒ«ãƒ‰ã®å…‰
                        const shieldLight = new THREE.PointLight(0x00ff00, 1, 5);
                        player.shield.add(shieldLight);
                    }

                    createScorePopup("ã‚·ãƒ¼ãƒ«ãƒ‰ç™ºå‹•!", player.position);
                    break;

                case 'bomb':
                    // ç”»é¢ä¸Šã®å…¨ã¦ã®æ•µã‚’çˆ†ç™ºã•ã›ã‚‹
                    const enemiesClone = [...enemies]; // é…åˆ—ã®ã‚³ãƒ”ãƒ¼ã‚’ä½œæˆï¼ˆå‰Šé™¤ä¸­ã«é…åˆ—ãŒå¤‰æ›´ã•ã‚Œã‚‹ãŸã‚ï¼‰
                    enemiesClone.forEach(enemy => {
                        // çˆ†ç™ºã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                        createExplosion(enemy.position.clone());

                        // æ•µã‚’å‰Šé™¤
                        scene.remove(enemy);
                        const index = enemies.indexOf(enemy);
                        if (index > -1) {
                            enemies.splice(index, 1);
                        }

                        // ã‚¹ã‚³ã‚¢åŠ ç®—
                        score += 100;
                    });

                    // ã‚¹ã‚³ã‚¢è¡¨ç¤ºã‚’æ›´æ–°
                    document.getElementById('scoreDisplay').textContent = score;

                    // ç”»é¢ã‚·ã‚§ã‚¤ã‚¯
                    shakeCamera(1.0, 1.0);

                    // é€šçŸ¥
                    createScorePopup("ãƒœãƒ ç™ºå‹•ï¼å…¨æ»…ï¼", player.position);

                    // å…¨ã¦ã®æ•µã‚’å€’ã—ãŸã‚‰ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢
                    if (enemies.length === 0) {
                        // ãƒœã‚¹ã‚’å‡ºç¾ã•ã›ã‚‹
                        setTimeout(spawnBoss, 3000);
                    }
                    break;

                case 'speedBoost':
                    playerPowerups.speedBoost.active = true;
                    playerPowerups.speedBoost.startTime = time;

                    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç§»å‹•é€Ÿåº¦ã‚’2å€ã«
                    playerSpeed = 0.3;

                    // é€šçŸ¥
                    createScorePopup("ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚¢ãƒƒãƒ—ï¼", player.position);

                    // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                    const speedTrail = new THREE.PointLight(0xffff00, 1, 3);
                    speedTrail.position.set(0, 0, 0);
                    player.add(speedTrail);
                    player.speedTrail = speedTrail;
                    break;

                case 'health':
                    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä½“åŠ›å›å¾©ï¼ˆã“ã“ã§ã¯ç„¡æ•µæ™‚é–“ã‚’ä»˜ä¸ã™ã‚‹ï¼‰
                    playerPowerups.shield.active = true;
                    playerPowerups.shield.startTime = time;
                    playerPowerups.shield.duration = 5; // 5ç§’é–“ã®ç„¡æ•µæ™‚é–“

                    // å›å¾©ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                    const healEffect = new THREE.PointLight(0xff00ff, 2, 10);
                    healEffect.position.copy(player.position);
                    scene.add(healEffect);

                    // 2ç§’å¾Œã«æ¶ˆãˆã‚‹
                    setTimeout(() => {
                        scene.remove(healEffect);
                    }, 2000);

                    // é€šçŸ¥
                    createScorePopup("å›å¾©ï¼ä¸€æ™‚ç„¡æ•µï¼", player.position);
                    break;
            }

            updatePowerupUI();
        }

        // è¡çªåˆ¤å®šï¼ˆæœ€é©åŒ–ã‚³ãƒ¡ãƒ³ãƒˆï¼šãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šã®ãŸã‚ã€ä¸€éƒ¨å‡¦ç†ã‚’æœ€é©åŒ–ï¼‰
        function checkCollisions() {
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨æ•µã®å¼¾ã®è¡çª
            bullets.forEach((bullet, bulletIndex) => {
                // ç”»é¢å¤–ã®å¼¾ã¯è¡çªåˆ¤å®šã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆæœ€é©åŒ–ï¼‰
                if (bullet.position.z < -40 || bullet.position.z > 40 || 
                    bullet.position.x < -40 || bullet.position.x > 40) {
                    return;
                }

                if (!bullet.isPlayerBullet) {
                    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã®è·é›¢ã‚’è¨ˆç®—
                    const distance = bullet.position.distanceTo(player.position);
                    if (distance < 1) {
                        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒãƒ’ãƒƒãƒˆ
                        scene.remove(bullet);
                        bullets.splice(bulletIndex, 1);

                        // ã‚·ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚Œã°é˜²å¾¡
                        if (playerPowerups.shield.active) {
                            // ã‚·ãƒ¼ãƒ«ãƒ‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                            createScorePopup("ã‚·ãƒ¼ãƒ«ãƒ‰é˜²å¾¡!", player.position);
                            shakeCamera(0.2, 0.2);
                            return;
                        }

                        // ç”»é¢ã‚·ã‚§ã‚¤ã‚¯åŠ¹æœ
                        shakeCamera(0.5, 0.5);

                        // ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                        createDamageEffect();

                        // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼
                        gameOver();
                        return;
                    }
                } else {
                    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å¼¾ã¨æ•µã®è¡çª
                    enemies.forEach((enemy, enemyIndex) => {
                        // é ãã®æ•µã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆå¤§ã¾ã‹ãªè·é›¢ãƒã‚§ãƒƒã‚¯ - æœ€é©åŒ–ï¼‰
                        if (Math.abs(bullet.position.z - enemy.position.z) > 10) {
                            return; // ã“ã®æ•µã‚’ã‚¹ã‚­ãƒƒãƒ—
                        }

                        const distance = bullet.position.distanceTo(enemy.position);
                        const hitSize = enemy.isBoss ? 3 : 1; // ãƒœã‚¹ã¯å½“ãŸã‚Šåˆ¤å®šãŒå¤§ãã„

                        if (distance < hitSize) {
                            // å¼¾ã‚’å‰Šé™¤
                            scene.remove(bullet);
                            bullets.splice(bulletIndex, 1);

                            if (enemy.isBoss) {
                                // ãƒœã‚¹ãŒãƒ’ãƒƒãƒˆ
                                enemy.health -= 1;

                                // ãƒ˜ãƒ«ã‚¹ãƒãƒ¼ã‚’æ›´æ–°
                                updateBossHealthBar();

                                // ãƒ’ãƒƒãƒˆã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆå°ã•ãªçˆ†ç™ºï¼‰
                                const hitPosition = bullet.position.clone();
                                createExplosion(hitPosition);

                                // ãƒ’ãƒƒãƒˆéŸ³
                                playSound('explosion');

                                // ã‚¹ã‚³ã‚¢åŠ ç®—
                                score += 50;
                                document.getElementById('scoreDisplay').textContent = score;

                                // ã‚¹ã‚³ã‚¢ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                                createScorePopup("+50", hitPosition);

                                // å°ã•ãªç”»é¢ã‚·ã‚§ã‚¤ã‚¯
                                shakeCamera(0.1, 0.1);

                                // ãƒœã‚¹ã®ãƒ•ã‚§ãƒ¼ã‚ºãƒã‚§ãƒƒã‚¯
                                const healthRatio = enemy.health / enemy.maxHealth;
                                for (let i = enemy.currentPhase; i < enemy.phaseThresholds.length; i++) {
                                    if (healthRatio <= enemy.phaseThresholds[i]) {
                                        enemy.currentPhase = i + 1;

                                        // ãƒ•ã‚§ãƒ¼ã‚ºå¤‰æ›´é€šçŸ¥
                                        createScorePopup("ãƒœã‚¹ãŒæ€’ã£ãŸï¼", enemy.position);

                                        // æ”»æ’ƒãƒ‘ã‚¿ãƒ¼ãƒ³å¤‰æ›´
                                        enemy.attackPattern = enemy.currentPhase;

                                        // ãƒœã‚¹ã®è‰²ã‚’å¤‰æ›´
                                        switch(enemy.currentPhase) {
                                            case 1:
                                                enemy.material.color.set(0xff6600); // ã‚ªãƒ¬ãƒ³ã‚¸
                                                enemy.material.emissive.set(0x551100);
                                                break;
                                            case 2:
                                                enemy.material.color.set(0xffff00); // é»„è‰²
                                                enemy.material.emissive.set(0x555500);
                                                break;
                                            case 3:
                                                enemy.material.color.set(0xffffff); // ç™½
                                                enemy.material.emissive.set(0x555555);
                                                break;
                                        }

                                        // å¤§ããªç”»é¢ã‚·ã‚§ã‚¤ã‚¯
                                        shakeCamera(0.5, 0.5);

                                        break;
                                    }
                                }

                                // ãƒœã‚¹ã‚’å€’ã—ãŸå ´åˆ
                                if (enemy.health <= 0) {
                                    // å¤§çˆ†ç™ºã‚¨ãƒ•ã‚§ã‚¯ãƒˆ - å›æ•°ã‚’æ¸›ã‚‰ã—ã¦æœ€é©åŒ–
                                    for (let i = 0; i < 5; i++) { // 10ã‹ã‚‰5ã«å‰Šæ¸›
                                        setTimeout(() => {
                                            const offset = new THREE.Vector3(
                                                (Math.random() - 0.5) * 5,
                                                (Math.random() - 0.5) * 5,
                                                (Math.random() - 0.5) * 5
                                            );
                                            createExplosion(enemy.position.clone().add(offset));
                                        }, i * 300); // ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚‚å°‘ã—åºƒã’ã‚‹
                                    }

                                    // ãƒœã‚¹ã‚’å‰Šé™¤
                                    scene.remove(enemy);
                                    enemies.splice(enemyIndex, 1);

                                    // ãƒ˜ãƒ«ã‚¹ãƒãƒ¼ã‚’å‰Šé™¤
                                    const healthBar = document.getElementById('bossHealthBarContainer');
                                    if (healthBar) {
                                        document.body.removeChild(healthBar);
                                    }

                                    // å¤§ããªç”»é¢ã‚·ã‚§ã‚¤ã‚¯
                                    shakeCamera(1.0, 1.0);

                                    // ã‚¹ã‚³ã‚¢åŠ ç®—
                                    score += 5000;
                                    document.getElementById('scoreDisplay').textContent = score;

                                    // ã‚¹ã‚³ã‚¢ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                                    createScorePopup("+5000 ãƒœã‚¹æ’ƒç ´ï¼", enemy.position);

                                    // ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢
                                    setTimeout(() => {
                                        gameWin();
                                    }, 2000);
                                }
                            } else {
                                // é€šå¸¸ã®æ•µãŒãƒ’ãƒƒãƒˆ
                                // çˆ†ç™ºã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                                createExplosion(enemy.position.clone());

                                // æ•µã‚’å‰Šé™¤
                                scene.remove(enemy);
                                enemies.splice(enemyIndex, 1);

                                // ã‚¹ã‚³ã‚¢åŠ ç®—
                                score += 100;
                                document.getElementById('scoreDisplay').textContent = score;

                                // ã‚¹ã‚³ã‚¢ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                                createScorePopup("+100", enemy.position);

                                // å…¨ã¦ã®æ•µã‚’å€’ã—ãŸã‚‰ãƒœã‚¹å‡ºç¾
                                if (enemies.length === 0) {
                                    setTimeout(spawnBoss, 3000);
                                }
                            }
                            return;
                        }
                    });
                }
            });

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ã®è¡çª
            if (player) {
                powerUps.forEach((powerUp, index) => {
                    const distance = powerUp.position.distanceTo(player.position);
                    if (distance < 1.5) {
                        // ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—å–å¾—
                        scene.remove(powerUp);
                        powerUps.splice(index, 1);

                        // ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—éŸ³
                        playSound('powerup');

                        // ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—åŠ¹æœé©ç”¨
                        applyPowerup(powerUp.powerUpType);

                        // å–å¾—ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                        createExplosion(powerUp.position.clone());
                    }
                });
            }
        }

        // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼å‡¦ç†
        function gameOver() {
            isGameOver = true;
            isGameActive = false;

            // BGMåœæ­¢
            if (sounds.bgm) {
                sounds.bgm.pause();
                sounds.bgm.currentTime = 0;
            }

            // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼éŸ³
            playSound('gameOver');

            document.getElementById('finalScore').textContent = score;
            document.getElementById('gameOver').style.display = 'block';
        }

        // ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢å‡¦ç†
        function gameWin() {
            isGameOver = true;
            isGameActive = false;

            // BGMåœæ­¢
            if (sounds.bgm) {
                sounds.bgm.pause();
                sounds.bgm.currentTime = 0;
            }

            // ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢éŸ³
            playSound('gameWin');

            document.getElementById('gameOver').querySelector('div:first-child').textContent = 'ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ï¼';
            document.getElementById('finalScore').textContent = score;
            document.getElementById('gameOver').style.display = 'block';
        }

        // ã‚«ãƒ¡ãƒ©ã‚·ã‚§ã‚¤ã‚¯åŠ¹æœ
        function shakeCamera(intensity, duration) {
            cameraShake.active = true;
            cameraShake.intensity = intensity;
            cameraShake.duration = duration;
            cameraShake.startTime = clock.getElapsedTime();
        }

        // ã‚«ãƒ¡ãƒ©ã‚·ã‚§ã‚¤ã‚¯ã®æ›´æ–°
        function updateCameraShake() {
            if (!cameraShake.active) return;

            const currentTime = clock.getElapsedTime();
            const elapsedTime = currentTime - cameraShake.startTime;

            if (elapsedTime > cameraShake.duration) {
                cameraShake.active = false;
                camera.position.x = player.position.x;
                camera.position.y = player.position.y + 2;
                camera.position.z = player.position.z + 2;
                return;
            }

            // æ®‹ã‚Šæ™‚é–“ã«åŸºã¥ã„ã¦å¼·åº¦ã‚’æ¸›è¡°
            const remainingFactor = 1 - (elapsedTime / cameraShake.duration);
            const currentIntensity = cameraShake.intensity * remainingFactor;

            // ãƒ©ãƒ³ãƒ€ãƒ ãªã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’é©ç”¨
            camera.position.x = player.position.x + (Math.random() - 0.5) * currentIntensity;
            camera.position.y = player.position.y + 2 + (Math.random() - 0.5) * currentIntensity;
            camera.position.z = player.position.z + 2 + (Math.random() - 0.5) * currentIntensity;
        }

        // ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
        function createDamageEffect() {
            // ç”»é¢ã‚’ä¸€ç¬èµ¤ãç‚¹æ»…ã•ã›ã‚‹
            const overlay = document.createElement('div');
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.backgroundColor = 'rgba(255, 0, 0, 0.3)';
            overlay.style.pointerEvents = 'none';
            overlay.style.zIndex = '1000';
            overlay.style.transition = 'opacity 0.5s';

            document.body.appendChild(overlay);

            // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
            setTimeout(() => {
                overlay.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(overlay);
                }, 500);
            }, 100);
        }

        // çˆ†ç™ºã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
        function createExplosion(position) {
            // çˆ†ç™ºéŸ³
            playSound('explosion');

            // çˆ†ç™ºã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«æ•°ã‚’æ¸›ã‚‰ã—ã¦æœ€é©åŒ–
            const particleCount = 10; // 20ã‹ã‚‰10ã«å‰Šæ¸›
            const explosionGroup = new THREE.Group();
            explosionGroup.position.copy(position);

            // çˆ†ç™ºã®ä¸­å¿ƒã®å…‰
            const light = new THREE.PointLight(0xff9900, 2, 10);
            light.position.set(0, 0, 0);
            explosionGroup.add(light);

            // å…±æœ‰ã‚¸ã‚ªãƒ¡ãƒˆãƒªã¨ãƒãƒ†ãƒªã‚¢ãƒ«ã‚’ä½¿ç”¨ã—ã¦æœ€é©åŒ–
            const geometry = new THREE.SphereGeometry(0.2, 6, 6); // è§£åƒåº¦ã‚‚ä¸‹ã’ã‚‹

            // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«
            for (let i = 0; i < particleCount; i++) {
                const material = new THREE.MeshBasicMaterial({
                    color: new THREE.Color(
                        Math.random() * 0.2 + 0.8, // R: èµ¤ï½ã‚ªãƒ¬ãƒ³ã‚¸
                        Math.random() * 0.5,       // G: å°‘ã—ç·‘
                        0                          // B: é’ãªã—
                    ),
                    transparent: true,
                    opacity: 1
                });

                const particle = new THREE.Mesh(geometry, material);
                const scale = Math.random() * 0.5 + 0.5;
                particle.scale.set(scale, scale, scale);

                // ãƒ©ãƒ³ãƒ€ãƒ ãªæ–¹å‘ã¨é€Ÿåº¦
                const speed = Math.random() * 4 + 2; // é€Ÿåº¦ç¯„å›²ã‚‚å°‘ã—ç‹­ã
                particle.velocity = new THREE.Vector3(
                    (Math.random() - 0.5) * speed,
                    (Math.random() - 0.5) * speed,
                    (Math.random() - 0.5) * speed
                );

                particle.lifespan = Math.random() * 0.4 + 0.3; // å¯¿å‘½ã‚’å°‘ã—çŸ­ã
                particle.age = 0;

                explosionGroup.add(particle);
            }

            scene.add(explosionGroup);
            explosions.push({
                group: explosionGroup,
                age: 0,
                duration: 1.0 // çˆ†ç™ºã®æŒç¶šæ™‚é–“ï¼ˆç§’ï¼‰
            });

            // å°ã•ãªç”»é¢ã‚·ã‚§ã‚¤ã‚¯
            shakeCamera(0.2, 0.2);
        }

        // çˆ†ç™ºã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®æ›´æ–°
        function updateExplosions(delta) {
            for (let i = explosions.length - 1; i >= 0; i--) {
                const explosion = explosions[i];
                explosion.age += delta;

                if (explosion.age >= explosion.duration) {
                    // çˆ†ç™ºã®å¯¿å‘½ãŒå°½ããŸã‚‰å‰Šé™¤
                    scene.remove(explosion.group);
                    explosions.splice(i, 1);
                    continue;
                }

                // é€²è¡Œåº¦ï¼ˆ0ï½1ï¼‰
                const progress = explosion.age / explosion.duration;

                // çˆ†ç™ºã®å…‰ã®å¼·åº¦ã‚’æ¸›è¡°
                const light = explosion.group.children[0];
                light.intensity = 2 * (1 - progress);

                // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã®æ›´æ–°
                for (let j = 1; j < explosion.group.children.length; j++) {
                    const particle = explosion.group.children[j];

                    // ä½ç½®ã®æ›´æ–°
                    particle.position.add(particle.velocity.clone().multiplyScalar(delta));

                    // é€Ÿåº¦ã®æ¸›è¡°
                    particle.velocity.multiplyScalar(0.95);

                    // å¹´é½¢ã®æ›´æ–°
                    particle.age += delta;

                    // é€æ˜åº¦ã®æ›´æ–°ï¼ˆå¾ã€…ã«æ¶ˆãˆã‚‹ï¼‰
                    if (particle.age >= particle.lifespan) {
                        particle.material.opacity = 0;
                    } else {
                        particle.material.opacity = 1 - (particle.age / particle.lifespan);
                    }

                    // ã‚µã‚¤ã‚ºã®æ›´æ–°ï¼ˆå¾ã€…ã«å°ã•ããªã‚‹ï¼‰
                    const scale = 1 - (particle.age / particle.lifespan) * 0.5;
                    particle.scale.set(scale, scale, scale);
                }
            }
        }

        // ã‚¹ã‚³ã‚¢ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
        function createScorePopup(text, position) {
            // 3Dç©ºé–“ä¸Šã®ã‚¹ã‚³ã‚¢ãƒ†ã‚­ã‚¹ãƒˆ
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = 128;
            canvas.height = 64;

            context.fillStyle = 'rgba(0, 0, 0, 0)';
            context.fillRect(0, 0, canvas.width, canvas.height);

            context.font = 'bold 36px Arial';
            context.textAlign = 'center';
            context.textBaseline = 'middle';

            // ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
            const gradient = context.createLinearGradient(0, 0, canvas.width, 0);
            gradient.addColorStop(0, '#ffff00');
            gradient.addColorStop(0.5, '#ffffff');
            gradient.addColorStop(1, '#ffff00');
            context.fillStyle = gradient;

            context.fillText(text, canvas.width / 2, canvas.height / 2);

            // ãƒ†ã‚¯ã‚¹ãƒãƒ£ã¨ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆä½œæˆ
            const texture = new THREE.CanvasTexture(canvas);
            const material = new THREE.SpriteMaterial({
                map: texture,
                transparent: true,
                opacity: 1
            });

            const sprite = new THREE.Sprite(material);
            sprite.position.copy(position);
            sprite.position.y += 1; // å°‘ã—ä¸Šã«è¡¨ç¤º
            sprite.scale.set(2, 1, 1);

            scene.add(sprite);

            scorePopups.push({
                sprite: sprite,
                age: 0,
                duration: 1.0 // è¡¨ç¤ºæ™‚é–“ï¼ˆç§’ï¼‰
            });
        }

        // ã‚¹ã‚³ã‚¢ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®æ›´æ–°
        function updateScorePopups(delta) {
            for (let i = scorePopups.length - 1; i >= 0; i--) {
                const popup = scorePopups[i];
                popup.age += delta;

                if (popup.age >= popup.duration) {
                    // å¯¿å‘½ãŒå°½ããŸã‚‰å‰Šé™¤
                    scene.remove(popup.sprite);
                    scorePopups.splice(i, 1);
                    continue;
                }

                // é€²è¡Œåº¦ï¼ˆ0ï½1ï¼‰
                const progress = popup.age / popup.duration;

                // ä¸Šã«æµ®ã‹ã³ä¸ŠãŒã‚‹
                popup.sprite.position.y += delta * 2;

                // é€æ˜åº¦ã®æ›´æ–°ï¼ˆå¾ã€…ã«æ¶ˆãˆã‚‹ï¼‰
                popup.sprite.material.opacity = 1 - progress;

                // ã‚µã‚¤ã‚ºã®æ›´æ–°ï¼ˆæœ€åˆã¯å¤§ããã€å¾ã€…ã«é€šå¸¸ã‚µã‚¤ã‚ºã«ï¼‰
                const scale = 2 - progress * 0.5;
                popup.sprite.scale.set(scale * 2, scale, 1);
            }
        }

        // é›£æ˜“åº¦ãƒ¬ãƒ™ãƒ«ã®ãƒã‚§ãƒƒã‚¯ã¨æ›´æ–°
        function checkDifficultyLevel() {
            // å‰å›ã®ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã‹ã‚‰ã®ã‚¹ã‚³ã‚¢å¢—åŠ ã‚’ãƒã‚§ãƒƒã‚¯
            if (score - difficulty.lastLevelUpScore >= difficulty.scoreThreshold && difficulty.level < difficulty.maxLevel) {
                // é›£æ˜“åº¦ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—
                difficulty.level++;
                difficulty.lastLevelUpScore = score;

                // æ•µã®é€Ÿåº¦ã¨å°„æ’ƒé »åº¦ã‚’å¢—åŠ 
                difficulty.enemySpeed += 0.02;
                difficulty.enemyFireRate += 0.005;

                // æ•µã®é€Ÿåº¦ã‚’æ›´æ–°
                enemies.forEach(enemy => {
                    enemy.speed = difficulty.enemySpeed;
                });

                // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—é€šçŸ¥
                createLevelUpNotification();
            }
        }

        // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—é€šçŸ¥
        function createLevelUpNotification() {
            // ç”»é¢ä¸­å¤®ã«å¤§ããªãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤º
            const levelUpDiv = document.createElement('div');
            levelUpDiv.style.position = 'fixed';
            levelUpDiv.style.top = '50%';
            levelUpDiv.style.left = '50%';
            levelUpDiv.style.transform = 'translate(-50%, -50%)';
            levelUpDiv.style.color = '#ffff00';
            levelUpDiv.style.fontSize = '48px';
            levelUpDiv.style.fontWeight = 'bold';
            levelUpDiv.style.textShadow = '0 0 10px #ff0000, 0 0 20px #ff0000';
            levelUpDiv.style.zIndex = '1000';
            levelUpDiv.style.pointerEvents = 'none';
            levelUpDiv.style.opacity = '1';
            levelUpDiv.style.transition = 'opacity 2s';
            levelUpDiv.textContent = `ãƒ¬ãƒ™ãƒ« ${difficulty.level}ï¼ é›£æ˜“åº¦ã‚¢ãƒƒãƒ—ï¼`;

            document.body.appendChild(levelUpDiv);

            // åŠ¹æœéŸ³
            playSound('powerup');

            // ç”»é¢ã‚·ã‚§ã‚¤ã‚¯
            shakeCamera(0.3, 0.5);

            // 2ç§’å¾Œã«ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
            setTimeout(() => {
                levelUpDiv.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(levelUpDiv);
                }, 2000);
            }, 2000);
        }

        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ—
        function animate() {
            requestAnimationFrame(animate);

            if (!isGameActive) return;

            const delta = clock.getDelta();
            const time = clock.getElapsedTime();

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–°
            if (player && player.mixer) {
                player.mixer.update(delta);
            }

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç§»å‹•
            if (player) {
                if (moveForward) player.position.z -= playerSpeed;
                if (moveBackward) player.position.z += playerSpeed;
                if (moveLeft) player.position.x -= playerSpeed;
                if (moveRight) player.position.x += playerSpeed;

                // ç§»å‹•ç¯„å›²ã®åˆ¶é™
                player.position.x = Math.max(-20, Math.min(20, player.position.x));
                player.position.z = Math.max(-20, Math.min(20, player.position.z));

                // ã‚«ãƒ¡ãƒ©ã‚’ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«è¿½å¾“ï¼ˆã‚ˆã‚Šè¿‘ãï¼‰
                camera.position.x = player.position.x;
                camera.position.y = player.position.y + 2;
                camera.position.z = player.position.z +2; // ã‚ˆã‚Šè¿‘ãã«é…ç½®
                camera.lookAt(player.position.x, player.position.y, player.position.z - 5);
            }

            // å°„æ’ƒã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³
            if (!canShoot && time - lastShootTime > shootCooldown) {
                canShoot = true;
            }

            // æ•µã®ãƒ©ãƒ³ãƒ€ãƒ å°„æ’ƒ
            if (enemies.length > 0) {
                // ãƒœã‚¹ã®æ”»æ’ƒãƒ‘ã‚¿ãƒ¼ãƒ³
                const boss = enemies.find(enemy => enemy.isBoss);
                if (boss) {
                    const currentTime = clock.getElapsedTime();

                    // æ”»æ’ƒã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
                    if (currentTime - boss.lastAttackTime > boss.attackCooldown) {
                        boss.lastAttackTime = currentTime;

                        // æ”»æ’ƒãƒ‘ã‚¿ãƒ¼ãƒ³ã«åŸºã¥ã„ã¦æ”»æ’ƒ
                        switch(boss.attackPattern) {
                            case 0: // é€šå¸¸æ”»æ’ƒï¼ˆå˜ç™ºï¼‰
                                createBullet(false, boss);
                                break;

                            case 1: // æ‹¡æ•£æ”»æ’ƒï¼ˆ3ç™ºï¼‰
                                createBullet(false, boss, -1, 0, -0.2);
                                createBullet(false, boss);
                                createBullet(false, boss, 1, 0, 0.2);
                                break;

                            case 2: // å††å½¢æ”»æ’ƒï¼ˆ8ç™ºï¼‰
                                for (let i = 0; i < 8; i++) {
                                    const angle = (i / 8) * Math.PI * 2;
                                    const vx = Math.sin(angle) * 0.5;
                                    const vz = Math.cos(angle) * 0.5;
                                    createBullet(false, boss, Math.sin(angle) * 2, 0, vx, vz);
                                }
                                break;

                            case 3: // è¶…æ‹¡æ•£æ”»æ’ƒï¼ˆ6ç™ºã«å‰Šæ¸›ï¼‰+ ãƒ¬ãƒ¼ã‚¶ãƒ¼
                                // å††å½¢æ”»æ’ƒã®å¼¾æ•°ã‚’æ¸›ã‚‰ã—ã¦6ç™ºã«
                                for (let i = 0; i < 6; i++) {
                                    const angle = (i / 6) * Math.PI * 2;
                                    const vx = Math.sin(angle) * 0.5;
                                    const vz = Math.cos(angle) * 0.5;
                                    createBullet(false, boss, Math.sin(angle) * 2, 0, vx, vz);
                                }

                                // ãƒ¬ãƒ¼ã‚¶ãƒ¼æ”»æ’ƒï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ç‹™ã†ï¼‰
                                const directionToPlayer = new THREE.Vector3()
                                    .subVectors(player.position, boss.position)
                                    .normalize();

                                // ãƒ¬ãƒ¼ã‚¶ãƒ¼ãƒ“ãƒ¼ãƒ ã¯å¤§ãã‚ã«
                                const laserBullet = createBullet(false, boss, 0, 0, directionToPlayer.x, directionToPlayer.z);
                                laserBullet.scale.set(2.5, 2.5, 2.5); // ãƒ¬ãƒ¼ã‚¶ãƒ¼ãƒ“ãƒ¼ãƒ ã‚’å¤§ãã
                                break;
                        }
                    }
                } else if (Math.random() < difficulty.enemyFireRate) {
                    // é€šå¸¸ã®æ•µã®ãƒ©ãƒ³ãƒ€ãƒ å°„æ’ƒ
                    createBullet(false);
                }
            }

            // é›£æ˜“åº¦ã®æ›´æ–°ã‚’ãƒã‚§ãƒƒã‚¯
            checkDifficultyLevel();

            // æ•µã®ç§»å‹•
            let needsDirectionChange = false;
            enemies.forEach(enemy => {
                // æ¨ªç§»å‹•
                enemy.position.x += enemy.speed * enemy.direction;

                // ä¸Šä¸‹ã®æºã‚Œ
                enemy.position.y = 1 + Math.sin(time + enemy.phaseOffset) * enemy.amplitude;

                // ç”»é¢ç«¯ã«åˆ°é”ã—ãŸã‚‰æ–¹å‘è»¢æ›ã®ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
                if (enemy.position.x > 20 || enemy.position.x < -20) {
                    needsDirectionChange = true;
                }

                // å›è»¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                enemy.rotation.z += 0.01;
            });

            // å…¨ã¦ã®æ•µã®æ–¹å‘ã‚’åè»¢ã—ã€å‰é€²ã•ã›ã‚‹
            if (needsDirectionChange) {
                enemies.forEach(enemy => {
                    enemy.direction *= -1;
                    enemy.position.z += 0.5; // å‰é€²

                    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«è¿‘ã¥ãã™ããŸã‚‰ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼
                    if (enemy.position.z > player.position.z - 2) {
                        gameOver();
                    }
                });
            }

            // å¼¾ã®ç§»å‹•
            bullets.forEach((bullet, index) => {
                // é€Ÿåº¦ã«åŸºã¥ã„ã¦ä½ç½®ã‚’æ›´æ–°
                bullet.position.add(bullet.velocity);

                // ç”»é¢å¤–ã«å‡ºãŸã‚‰å‰Šé™¤
                if (bullet.position.z < -50 || bullet.position.z > 50) {
                    scene.remove(bullet);
                    bullets.splice(index, 1);
                }
            });

            // ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            powerUps.forEach(powerUp => {
                // å›è»¢
                powerUp.rotation.x += powerUp.rotationSpeed.x;
                powerUp.rotation.y += powerUp.rotationSpeed.y;
                powerUp.rotation.z += powerUp.rotationSpeed.z;

                // æµ®éŠ
                powerUp.position.y = 1 + Math.sin(time + powerUp.floatOffset) * powerUp.floatHeight;

                // å…‰ã®å¼·åº¦ã‚’å¤‰åŒ–ã•ã›ã‚‹
                if (powerUp.children.length > 0) {
                    const light = powerUp.children[0];
                    light.intensity = 1 + Math.sin(time * 2) * 0.3;
                }
            });

            // ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ã®åŠ¹æœæ™‚é–“ç®¡ç†
            updatePowerupEffects(time);

            // ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—UIã®æ›´æ–°
            updatePowerupUI();

            // è¡çªåˆ¤å®š
            checkCollisions();

            // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            animateParticles();

            // çˆ†ç™ºã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®æ›´æ–°
            updateExplosions(delta);

            // ã‚¹ã‚³ã‚¢ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®æ›´æ–°
            updateScorePopups(delta);

            // ã‚«ãƒ¡ãƒ©ã‚·ã‚§ã‚¤ã‚¯ã®æ›´æ–°
            updateCameraShake();

            // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            renderer.render(scene, camera);
        }

        // DOMèª­ã¿è¾¼ã¿å®Œäº†å¾Œã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM fully loaded');
            // ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
            document.getElementById('startButton').addEventListener('click', function() {
                console.log('Start button clicked');
                this.style.display = 'none';
                init();
            });
        });
    </script>
</body>
</html>
